<!DOCTYPE html>
<html>
<head>
  <title>可视化搭建Web页面其二</title>
  <link rel="stylesheet" href="/note/note.css?ts=1638116667233">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"><link rel="shortcut icon" href="/ico.png"></head>
<body><script>var _hmt = _hmt || [];
(function () {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?256376ad73e3e50091706bb3c032e74c";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>
<h1 id="-web-">可视化搭建Web页面其二</h1>
<p>上文提到要创建CLI工具来提高开发者开发效率。</p>
<h2 id="-">如何开始</h2>
<p>从头开始介绍如何开始创建一个node-cli来面向模板和组件开发者，减少重复劳动，提高工作效率。</p>
<pre><code class="lang-bash"><div class="highlight"><pre>mkdir my-cli
<span class="nb">cd </span>my-cli
npm init -y <span class="c"># 初始化package.json</span>
</pre></div>

</code></pre>
<p>接下来我们需要增加一个命令入口，指向可执行文件。需要在package.json文件中指明bin来配置入口。</p>
<pre><code class="lang-bash"><div class="highlight"><pre><span class="c">#!/usr/bin/env node</span>
</pre></div>

</code></pre>
<p>#!这个符号通常出现在Unix系统中，用于指明这个脚本文件的解释程序。增加上面那一行代码主要是为了指定用node执行脚本文件。</p>
<h2 id="-">常用模块</h2>
<p>1、chalk，终端显示颜色。</p>
<p>2、commander提供了命令行输入和参数解析。</p>
<p>3、inquirer交互式命令行工具，用来收集用户填入表单。</p>
<p>4、ora终端加载动画效果。</p>
<p>5、shelljs，代码中编写shell命令实现功能。</p>
<p>6、puppeteer启动无头浏览器生成网站缩略图。</p>
<p>7、download-git-repo，用来下载远程模板。</p>
<h2 id="create-">create模板、组件</h2>
<p>我们希望通过下面的命令来实现一个创建模板的功能，用于初始化模板脚手架。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">my</span><span class="o">-</span><span class="nx">cli</span> <span class="nx">create</span> <span class="nx">my</span><span class="o">-</span><span class="nx">template</span><span class="o">-</span><span class="nx">test</span>
</pre></div>

</code></pre>
<p>主要是使用inquirer来收集用户填入的表单，然后使用download-git-repo库来下载相应的git仓库代码即可。</p>
<h2 id="publish-">publish模板、组件</h2>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">my</span><span class="o">-</span><span class="nx">cli</span> <span class="nx">release</span>
</pre></div>

</code></pre>
<p>模板开发完毕后，需要将模板提交到编辑器后台管理系统中，用于运营选择我们的模板。这里其实干了两件事，第一步先生成开发好的模板的缩略图；第二步将我们的componet.config.js文件提交到服务器端。</p>
<p>组件发布也类似，主要使用puppeteer生成截图。</p>
<h2 id="-">初始化配置文件</h2>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">my</span><span class="o">-</span><span class="nx">cli</span> <span class="nx">init</span><span class="o">-</span><span class="nx">config</span>
</pre></div>

</code></pre>
<p>检测当前目录下是否存在component.config.js文件，不存在则直接按模板和用户输入生成即可。</p>
<h2 id="cli-">CLI文件夹结构</h2>
<pre><code class="lang-bash"><div class="highlight"><pre>my-cli
├─package.json
├─tpl
<span class="p">|</span>  ├─component.config.js
<span class="p">|</span>  └-page.config.js
├─lib
├─commands
<span class="p">|</span>    ├─generator.js
<span class="p">|</span>    ├─release.js
<span class="p">|</span>    └init-config.js
├─bin
<span class="p">|</span>  └index.js
</pre></div>

</code></pre>
<p>index.js是主入口文件，commands专门放主要的命名功能逻辑，lib比较细的功能实现，tpl放置文件模板。</p>
<h2 id="-">可视化编辑区实现</h2>
<p>我们编辑器对模板的展示采用的是iframe的方式，之前我们提采用iframe的方式是为了模板和编辑器解耦。我们也可以通过监听postMessage的方式来实现消息接收。</p>
<h3 id="-">选择组件</h3>
<p>可视化编辑器要实现的第一个功能就是对页面组件进行选择性编辑。首先看一下竞对的交互：选中组件后进行高亮，之后进行拖拽排序。</p>
<p>选中组件后高亮按照设计模式来说，应该是编辑器实现的功能。这就涉及到了父iframe操作子iframe的问题。只需要页面和编辑器设置相同的主域名，便可以进行跨iframe的操作。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">const</span> <span class="nx">eventInit</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// 获取子 iframe 的 dom</span>
  <span class="kr">const</span> <span class="nx">componentsPND</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;frame&#39;</span><span class="p">).</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;slider-view&#39;</span><span class="p">);</span>
  <span class="c1">// 为页面组件绑定 click 事件</span>
  <span class="nx">componentsPND</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>
    <span class="c1">// 遍历元素，找到以 &#39;coco-render-id-_component_&#39;  作为 id 的组件元素，计算高度和位置</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">tagName</span> <span class="o">!==</span> <span class="s1">&#39;HTML&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">currentId</span> <span class="o">=</span> <span class="nx">node</span><span class="o">?</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">currentId</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;coco-render-id-_component_&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">getElementTop</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
        <span class="kr">const</span> <span class="p">{</span> <span class="nx">height</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
        <span class="nx">restStyle</span><span class="p">(</span><span class="nx">height</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span> <span class="s1">&#39;activeStyle&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="c1">// 为页面组件绑定 mouseover 事件</span>
  <span class="nx">componentsPND</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mouseover&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>
    <span class="c1">// 遍历元素，找到以 &#39;coco-render-id-_component_&#39;  作为 id 的组件元素，计算高度和位置</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">tagName</span> <span class="o">!==</span> <span class="s1">&#39;HTML&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">currentId</span> <span class="o">=</span> <span class="nx">node</span><span class="o">?</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">currentId</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;kaer-render-id-_component_&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="kr">const</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">getElementTop</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
          <span class="kr">const</span> <span class="p">{</span> <span class="nx">height</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
          <span class="nx">restStyle</span><span class="p">(</span><span class="nx">height</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span> <span class="s1">&#39;hoverStyle&#39;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// ignore</span>
        <span class="p">}</span>

      <span class="p">}</span>
      <span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h3 id="-">调整组件顺序</h3>
<p>按照云凤碟的交互实现方式，在可视化编辑区右侧挂上编辑操作按钮。主要是更改组件在数组中的顺序即可。</p>
<h3 id="-">添加组件</h3>
<p>添加组件，通过拖拽的方式动态添加到编辑区。主要通过HTML的拖放API。</p>
<h2 id="-mock-">可视区编辑器mock &amp; 预览</h2>
<h3 id="-mock">模板页面mock</h3>
<p>为了让页面模板在编辑时走mock，在非编辑环境下走真实网络请求，这就要求模板页面根据当前被内置的环境判断请求是否走mock。</p>
<h3 id="-">模板页面预览</h3>
<p>mock虽然解决了我们编辑器编辑的问题，但用户配置完页面信息后，如何验证配置的信息是否正确呢？需要加一个预览的功能，来检测配置项。</p>
<h2 id="vue3-form-render-">Vue3 Form render实现</h2>
<p>需要对模板和组件暴露出来的可编辑props转换为表单以供用户编辑使用。</p>
<p>vue-form-render需要接受一个schema入参用于表单描述，再接受一个formData入参作为表单初始值，当表单变更时需要提供change事件通知前端更新数据，如果表单输入不合法，则需要通过validate事件告知前端。</p>
<pre><code class="lang-html"><div class="highlight"><pre><span class="nt">&lt;formRender</span>
  <span class="na">:schema=</span><span class="s">&quot;schema&quot;</span>
  <span class="na">:formData=</span><span class="s">&quot;formData&quot;</span>
  <span class="err">@</span><span class="na">on-change=</span><span class="s">&quot;change&quot;</span>
  <span class="err">@</span><span class="na">on-validate=</span><span class="s">&quot;validate&quot;</span>
<span class="nt">/&gt;</span>
</pre></div>

</code></pre>
<h3 id="formdata-">formData处理</h3>
<p>如果schema是个多级的对象，需要按照shema的规范类深度遍历formData对象。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">schema</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span>
    <span class="c1">// 类型</span>
    <span class="nx">type</span>
  <span class="p">}</span> <span class="o">=</span> <span class="nx">schema</span><span class="p">;</span>
  <span class="c1">// 数据未初始化，给定默认值</span>
  <span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span>
    <span class="k">typeof</span> <span class="nx">data</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">getDefaultValue</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span> <span class="o">:</span> <span class="nx">clone</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 递归</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">subs</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">name</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// ...</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="nx">subs</span><span class="p">[</span><span class="nx">name</span><span class="p">],</span> <span class="nx">value</span><span class="p">[</span><span class="nx">name</span><span class="p">],</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;array&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 递归</span>
    <span class="nx">value</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">item</span><span class="p">,</span> <span class="nx">idx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// ...</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="nx">subs</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="o">||</span> <span class="nx">subs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//</span>
<span class="kd">function</span> <span class="nx">getDefaultValue</span><span class="p">(</span><span class="nx">schame</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">type</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">schema</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">defaultValue</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">array</span><span class="o">:</span> <span class="p">[],</span>
    <span class="kr">boolean</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">integer</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="kc">null</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">number</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="nx">object</span><span class="o">:</span> <span class="p">{},</span>
    <span class="nx">string</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="nx">range</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="p">};</span>

  <span class="c1">// ...</span>

  <span class="k">return</span> <span class="nx">defaultValue</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h3 id="-">表单渲染</h3>
<p>最简单的方式是写很多功能组件，input，number，richText，radio，checkbox等，然后根据schema的type来确定用哪个组件。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">setup</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">Field</span> <span class="o">=</span> <span class="nx">widgets</span><span class="p">[</span><span class="nx">mapping</span><span class="p">[</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">type</span><span class="p">}</span><span class="nx">$</span><span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">format</span> <span class="o">?</span> <span class="err">`</span><span class="o">:</span><span class="nx">$</span><span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">format</span><span class="p">}</span><span class="err">`</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span><span class="err">`</span><span class="p">]];</span>
      <span class="k">return</span> <span class="p">(</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&quot;vue-form-render&quot;</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="nx">Field</span>
            <span class="nx">schema</span><span class="o">=</span><span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">schema</span><span class="p">}</span>
            <span class="nx">formData</span><span class="o">=</span><span class="p">{</span><span class="nx">data</span><span class="p">}</span>
            <span class="nx">value</span><span class="o">=</span><span class="p">{</span><span class="nx">data</span><span class="p">}</span>
            <span class="nx">onChange</span><span class="o">=</span><span class="p">{</span><span class="nx">handleChange</span><span class="p">}</span>
          <span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="err">/div&gt;</span>
      <span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h3 id="-">校验输入</h3>
<p>校验需要做的一方面是对数据格式的基础校验，一方面需要对用户自定义规则校验。eg：图片的地址需要经过url格式的校验。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">format</span> <span class="o">===</span> <span class="s1">&#39;image&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">imagePattern</span> <span class="o">=</span>
    <span class="s1">&#39;([/|.|w|s|-])*.(?:jpg|gif|png|bmp|apng|webp|jpeg|json)&#39;</span><span class="p">;</span>
  <span class="c1">// image 里也可以填写网络链接</span>
  <span class="kr">const</span> <span class="nx">_isUrl</span> <span class="o">=</span> <span class="nx">isUrl</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">_isImg</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">imagePattern</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">usePattern</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ignore</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_isUrl</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">_isImg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">message</span> <span class="o">&amp;&amp;</span> <span class="nx">message</span><span class="p">.</span><span class="nx">image</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;请输入正确的图片格式&#39;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">format</span> <span class="o">===</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">usePattern</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ignore</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isUrl</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">message</span> <span class="o">&amp;&amp;</span> <span class="nx">message</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;请输入正确的url格式&#39;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h2 id="server-">Server端编译实现</h2>
<p>一部分可视化搭建系统中，没有涉及到编译这一块的内容，因为所有的数据都存储在云端，页面加载时再根据id来请求云端存储的数据。</p>
<p>这样存在一些问题：</p>
<p>1、用户体验问题，每次打开页面都会发起数据请求来获取页面配置数据。</p>
<p>2、增加服务器端压力，对于大促类型的活动，QPS是必须考虑的点，如果QPS过大则会影响服务端的负载。</p>
<p>3、额外的数据维护成本。</p>
<h3 id="server-">Server端编译</h3>
<p>我们知道模板的代码信息，其次我们知道页面配置的数据信息。根据这些信息，我们可以编译出页面。</p>
<h4 id="-">方式一：动态实时构建编译</h4>
<p>当后台提交渲染请求时，我们的node服务：1、拉取对应模板；2、渲染数据；3、编译。</p>
<h4 id="-">方式二：动态非实时编译</h4>
<p>方式一主要的弊端是发布时间长，以及间接修改了用户代码。如果我们将数据注入到编译后的静态文件，可以解决上述的问题。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">data</span><span class="o">-</span><span class="nx">inject</span><span class="o">&gt;</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">__coco_config__</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">components</span><span class="o">:</span> <span class="p">[]</span> <span class="p">};</span>
<span class="o">&lt;</span><span class="err">/script&gt;</span>
</pre></div>

</code></pre>
<pre><code class="lang-html"><div class="highlight"><pre><span class="c">&lt;!-- remote-script-inject-start --&gt;</span>
<span class="c">&lt;!-- remote-script-inject-end --&gt;</span>
</pre></div>

</code></pre>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// 注入数据</span>
<span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">temp_dest</span><span class="p">}</span><span class="o">/</span><span class="nx">dist</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">html</span><span class="err">`</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span>
  <span class="sr">/(?&lt;=&lt;script data-inject&gt;).*?(?=&lt;\/script&gt;)/</span><span class="p">,</span>
  <span class="err">`</span><span class="nb">window</span><span class="p">.</span><span class="nx">__coco_config__</span><span class="o">=</span> <span class="nx">$</span><span class="p">{</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
    <span class="p">...</span><span class="nx">data</span><span class="p">,</span>
    <span class="nx">components</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">userSelectComponents</span><span class="p">,</span>
    <span class="nx">pageData</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span>
  <span class="p">})}</span><span class="err">`</span>
<span class="p">);</span>
<span class="c1">// 修改title</span>
<span class="nx">target</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(?&lt;=&lt;title&gt;).*?(?=&lt;\/title&gt;)/</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">projectName</span><span class="p">);</span>
<span class="c1">// ...</span>
<span class="c1">// 远程组件注入</span>
<span class="nx">target</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span>
  <span class="sr">/(?&lt;=&lt;!-- remote-script-inject-start --&gt;).*?(?=&lt;!-- remote-script-inject-end --&gt;)/</span><span class="p">,</span>
  <span class="nx">cssStyle</span> <span class="o">+</span> <span class="nx">jsScripts</span>
<span class="p">);</span>
<span class="c1">// 文件写入，编译完成</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">temp_dest</span><span class="p">}</span><span class="o">/</span><span class="nx">dist</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">html</span><span class="err">`</span><span class="p">,</span> <span class="nx">target</span><span class="p">);</span>
</pre></div>

</code></pre>
<p>这样我们将所有的编辑数据和全局组件数据全部注入到window._coco_config_属性上，这样模板就不用再请求server端数据，也不用走Server端实时编译了。</p>
</body>
</html>
