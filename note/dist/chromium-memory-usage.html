<!DOCTYPE html>
<html>
<head>
  <title>Chromium内存使用背景知识</title>
  <link rel="stylesheet" href="/note/note.css?ts=1652285355309">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"><link rel="shortcut icon" href="/ico.png"></head>
<body><script>var _hmt = _hmt || [];
(function () {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?256376ad73e3e50091706bb3c032e74c";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>
<h1 id="chromium-">Chromium内存使用背景知识</h1>
<h2 id="-">多进程模型</h2>
<p>当Chromium启动时，初始会有一个浏览器进程和一个渲染器进程，当你新开一个浏览器Tab页时，你可能会得到一个新的渲染器进程。</p>
<p>插件，apps或扩展也可能在独立的进程中运行。所有的Chromium进程，在Windows的进程管理器中都叫chrome.exe。</p>
<p>从Windows XP以后的系统，进程管理器中的内存占用会低很多。因为后续的系统更新了内存占用衡量指标。</p>
<p>这两个操作系统主要测量一个进程的工作集，然而，工作集由三个不同的组成部分组成：</p>
<p>1、Private Working Set，仅此进程私有。</p>
<p>2、Shareable Woring Set，可共享的工作集。</p>
<p>3、Shared Working Set，当前进程正在与其它进程共享的工作集，这是可共享工作集的一个子集。</p>
<p>在Windows XP中，每个进程都使用总的Working Set表示内存占用。</p>
<p>在Windows Vista及以后变为了Private Working Set表示内存占用，这更加合理了。</p>
<h2 id="-">怎样衡量内存</h2>
<p>对于Chromium来说，我们想要找到一种可以衡量应用使用系统资源多少的指标。我们不能使用Total WorkingSet，因为这样会多次计算共享内存。</p>
<p>几乎所有的Windows应用都会受益于共享内存。例如：每一个进程都需要加载若干个Windows DLLS(kernel32,ntdll,user32)，这写DLL都被Windows在全部进程中共享。多次计算这些共享DLL将会增加10-50MB。</p>
<p>首先的指标跟Windows使用的类似，我们测量Working-Set。私有的算法为：Private Working Set + Shareable Working Set - Shared Working Set。</p>
<h2 id="-2">怎样衡量内存-2</h2>
<p>查看应用的Working Set并不是唯一的测量内存的方式。任何程序都会分配系统资源，消耗的常见资源是GDI内存，这个内存显示在系统的提交记录中，可能不会反映到工作集中。</p>
<p>要测量这一点，我们需要查看系统的总提交记录。总提交记录是所有应用程序和系统本身使用的内存总量。因为是系统维度的度量，最好关机重启进行测量。</p>
<h2 id="-">多进程模型的弱点</h2>
<p>使用多进程架构和构建轻量级浏览器矛盾。首先，每个进程都有一定数量的开销，但是一旦正确使用了共享内存，进程开销就会相对小很多。更重要的障碍是复制的浏览器内部组件，如缓存、JS虚拟机堆，内部数据结构，这些必须在多个进程中复制。</p>
<p>Chromium如何克服这些缺点？简而言之，这是不可能的。我们所能做的就是把其它所有东西都做得更小，这样多进程的影响就最小化了。</p>
<p>可以使用--single-process命令行来启动单进程模式。</p>
<h2 id="-">多进程模型在内存方面的优点</h2>
<p>第一个好处是：多进程浏览器更容易回收未使用的内存。当你关闭Tab时，所有的资源会被返还给系统。</p>
<p>第二个好处是：当内存紧张时，Chromium可以积极帮助操作系统。当内存紧张时，操作系统会从最小化的应用程序中获取内存页，Chromium对活动标签页也采用了完全相同的模式。单进程浏览器无法区分哪些选项卡正在使用哪些内存。</p>
<p>最后：多进程浏览器能够有选择地清理未使用的内存。如果你的系统内存不够用，可以使用Chromium的任务管理器来结束使用内存过多的Tab进程。</p>
<p>可以使用几种方式来帮助Windows系统管理内存。例如：如果你最小化了windows应用，Windows会自动释放应用的Working-Set给操作系统。</p>
<p>Chromium使用了类似的方式来处理Tab。当Tab进入后台后，Chromium会降低后台Tab的优先级并释放Tab的一些Working-Set。</p>
<p>当其它应用程序需要内存时，Chromium会让出自己的内存，以便前台应用程序可以响应。</p>
<p>同样，如果你让Chromium闲置一段时间，它会尝试把内存还给操作系统。</p>
<h2 id="-todo">减少内存使用的部分TODO</h2>
<p>字体管理：字体在内存中缓存的方式非常少。</p>
<p>字符串：重复的字符串是不好的。Blink/Chromium中的所有字符串都是unicode字符串。使用单字符可以减少体积。</p>
<p>历史子系统：SQLLite DB需要优化。</p>
<p>在内存中的缓存：Chrome目前使用一个共享缓存跨所有进程。当前最大大小为32MB。</p>
<p>JS：Chrome渲染器都有自己的JS虚拟机，减少JS的内存使用会反复带来好处。</p>
<p>工具：总是需要更好的工具。memory_watcher项目目前用于调试。</p>
<h2 id="-">参考文档</h2>
<p><a href="https://www.chromium.org/developers/memory-usage-backgrounder/">https://www.chromium.org/developers/memory-usage-backgrounder/</a></p>
</body>
</html>
