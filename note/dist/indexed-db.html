<!DOCTYPE html>
<html>
<head>
  <title>IndexedDB 学习笔记</title>
  <link rel="stylesheet" href="/note/note.css?ts=1640535102164">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"><link rel="shortcut icon" href="/ico.png"></head>
<body><script>var _hmt = _hmt || [];
(function () {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?256376ad73e3e50091706bb3c032e74c";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>
<h1 id="indexeddb-">IndexedDB 学习笔记</h1>
<p>随着浏览器的功能不断增强，越来越多的网站开始考虑，将大量数据存储到客户端，以降低服务器压力和提高响应速度。</p>
<p>现有的浏览器的存储方案，都不适合存储大量数据。</p>
<p>1、Cookie的大小不超过4KB，且每次请求都发送会服务器。</p>
<p>2、LocalStorage在2.5MB到10MB之间，而且不提供搜索功能，不能建立自定义索引。</p>
<p>IndexedDB是浏览器提供的本地数据库，可以被网页创建和操作。IndexedDB允许存储大量数据，提供查找接口，还能创建索引。</p>
<p>就数据库类型而言，IndexedDB不属于关系型数据库，不支持SQL查询，更接近NoSQL数据库。</p>
<h2 id="indexeddb-">IndexedDB特点</h2>
<p>1、键值对存储。IndexedDB内部采用对象仓库存放数据。所有类型的数据都可以直接存入，包括JS对象。数据以键值对的形式保存，每一个数据记录都有对应的主键。</p>
<p>2、异步。IndexedDB操作时不会锁死浏览器，用户依然可以进行其它操作。这与LocalStorage形成对比。异步设计是为了防止大量数据的读写，拖慢网页的表现。</p>
<p>3、支持事务，IndexedDB支持事务，一系列操作中，只要有一步失败，整个事务就都被取消，数据库回滚到事务发生之前的状态。</p>
<p>4、同源限制，IndexedDB受到同源限制。</p>
<p>5、存储空间大，IndexedDB的存储空间比LocalStorage大得多，一般来说不少于250MB，甚至没有上限。</p>
<p>6、支持二进制存储。IndexedDB不仅可以存储字符串，还可以存储二进制数据(ArrayBuffer对象和Blob对象)。</p>
<h2 id="-">基本概念</h2>
<h3 id="-">数据库</h3>
<p>数据库是一系列相关数据的容器，每个域名可以新建任意多个数据库。IndexedDB数据库有版本的概念，同一时刻，只能有一个版本的数据库存在。如果要修改数据库结构，新增或删除表，索引或主键，只能通过升级数据库版本完成。</p>
<h3 id="-">对象仓库</h3>
<p>每个数据库包含若干个对象仓库，它类似于关系型数据库的表格。</p>
<h3 id="-">数据记录</h3>
<p>对象仓库保存的是数据记录，每条记录类似于关系型数据库的行，但是只有主键和数据体两部分。主键用来建立默认的索引，必须是不同的，否则会报错。主键可以是数据记录里的一个属性，也可以指定为一个递增的整数编号。</p>
<p>数据体可以是任意数据类型，不限于对象。</p>
<h3 id="-">索引</h3>
<p>为了加速数据的检索，可以在对象仓库里面，为不同的属性建立索引。</p>
<h3 id="-">事务</h3>
<p>数据记录的读写和删改，都要通过事务完成。事务对象提供error，abort和complete三个事件，用来监听操作结果。</p>
<h2 id="-">操作流程</h2>
<h3 id="-">打开数据库</h3>
<p>使用IndexedDB的第一步是打开数据库，使用indexedDB.open方法。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">let</span> <span class="nx">request</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">indexedDB</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">databaseName</span><span class="p">,</span><span class="nx">version</span><span class="p">)</span>
<span class="c1">// 如果指定的数据库不存在，则创建，默认版本号为1</span>
</pre></div>

</code></pre>
<p>返回一个IDBRequest对象，这个对象通过三种事件error，success，upgradeneeed，处理打开数据库的操作结果。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">request</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;数据库打开报错&#39;</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>

</code></pre>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">db</span><span class="p">;</span>
<span class="nx">request</span><span class="p">.</span><span class="nx">onsuccess</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">db</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;数据库打开成功&#39;</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>

</code></pre>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">db</span><span class="p">;</span>
<span class="nx">request</span><span class="p">.</span><span class="nx">onupgradeneeded</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">db</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h3 id="-">新建数据库</h3>
<p>新建数据库和打开数据库是同一个操作。如果指定的数据库不存在，就会新建。不同之处在于，后续的操作主要在upgradeneeded事件的监听函数里面完成。</p>
<p>新建数据库以后，第一件事就是新建对象仓库。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">request</span><span class="p">.</span><span class="nx">onupgradeneeded</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">db</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">objectStore</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">db</span><span class="p">.</span><span class="nx">objectStoreNames</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">objectStore</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">createObjectStore</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">keyPath</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>主键key是默认索引的属性。主键也可以指定为下一层对象的属性。eg：{foo:{bar:&#39;baz&#39;}}，foo.bar也可以指定为主键。</p>
<p>如果数据记录里面没有合适的作为主键的属性。可以让IndexedDB自动生成主键。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">objectStore</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">createObjectStore</span><span class="p">(</span>
  <span class="s1">&#39;person&#39;</span><span class="p">,</span>
  <span class="p">{</span> <span class="nx">autoIncrement</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">);</span>
</pre></div>

</code></pre>
<p>新建对象仓库以后，下一步可以新建索引。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">request</span><span class="p">.</span><span class="nx">onupgradeneeded</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">db</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">objectStore</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">createObjectStore</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">keyPath</span><span class="o">:</span> <span class="s1">&#39;id&#39;</span> <span class="p">});</span>
  <span class="nx">objectStore</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">unique</span><span class="o">:</span> <span class="kc">false</span> <span class="p">});</span>
  <span class="nx">objectStore</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">unique</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h3 id="-">新增数据</h3>
<p>新增数据指的是向数据库对象仓库写入数据记录，这需要通过事务完成。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">add</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">([</span><span class="s1">&#39;person&#39;</span><span class="p">],</span> <span class="s1">&#39;readwrite&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">objectStore</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;张三&#39;</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">24</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;zhangsan@example.com&#39;</span> <span class="p">});</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">onsuccess</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;数据写入成功&#39;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;数据写入失败&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">add</span><span class="p">();</span>
</pre></div>

</code></pre>
<p>写入数据需要一个事务，新建时必须指定表格名称和操作模式(&#39;只读&#39;或&#39;读写&#39;)。新建事务后，通过IDBTransaction.objectStore(name)，拿到IDBObjectStore对象，再通过表格对象的add方法，向表格中写入一条记录。</p>
<p>写入是一个异步事件，通过监听连接对象的success事件和error事件，了解是否写入成功。</p>
<h3 id="-">读取数据</h3>
<p>读取数据也是通过事务完成。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">read</span><span class="p">()</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">([</span><span class="s1">&#39;person&#39;</span><span class="p">]);</span>
   <span class="kd">var</span> <span class="nx">objectStore</span> <span class="o">=</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">objectStore</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">);</span>
   <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">objectStore</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

   <span class="nx">request</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;事务失败&#39;</span><span class="p">);</span>
   <span class="p">};</span>

   <span class="nx">request</span><span class="p">.</span><span class="nx">onsuccess</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Name: &#39;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Age: &#39;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">age</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Email: &#39;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;未获得数据记录&#39;</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">};</span>
<span class="p">}</span>

<span class="nx">read</span><span class="p">();</span>
</pre></div>

</code></pre>
<p>objectStore.get方法用于读取数据，参数是主键的值。</p>
<h3 id="-">遍历数据</h3>
<p>遍历数据表格中的所有记录，要使用指针对象IDBCursor。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">readAll</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">objectStore</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">).</span><span class="nx">objectStore</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">);</span>

   <span class="nx">objectStore</span><span class="p">.</span><span class="nx">openCursor</span><span class="p">().</span><span class="nx">onsuccess</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
     <span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>

     <span class="k">if</span> <span class="p">(</span><span class="nx">cursor</span><span class="p">)</span> <span class="p">{</span>
       <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Id: &#39;</span> <span class="o">+</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
       <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Name: &#39;</span> <span class="o">+</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
       <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Age: &#39;</span> <span class="o">+</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">age</span><span class="p">);</span>
       <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Email: &#39;</span> <span class="o">+</span> <span class="nx">cursor</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">email</span><span class="p">);</span>
       <span class="nx">cursor</span><span class="p">.</span><span class="k">continue</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;没有更多数据了！&#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="nx">readAll</span><span class="p">();</span>
</pre></div>

</code></pre>
<p>openCursor方法是一个异步操作，所以需要监听success事件。</p>
<h3 id="-">更新数据</h3>
<p>更新数据使用IDBObject.put方法。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">update</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">([</span><span class="s1">&#39;person&#39;</span><span class="p">],</span> <span class="s1">&#39;readwrite&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">objectStore</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">put</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;李四&#39;</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">35</span><span class="p">,</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;lisi@example.com&#39;</span> <span class="p">});</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">onsuccess</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;数据更新成功&#39;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;数据更新失败&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">update</span><span class="p">();</span>
</pre></div>

</code></pre>
<h3 id="-">删除数据</h3>
<p>删除数据使用IDBObejctStore.delete方法用于删除记录。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">remove</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">([</span><span class="s1">&#39;person&#39;</span><span class="p">],</span> <span class="s1">&#39;readwrite&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">objectStore</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="nx">request</span><span class="p">.</span><span class="nx">onsuccess</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;数据删除成功&#39;</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="nx">remove</span><span class="p">();</span>
</pre></div>

</code></pre>
<h3 id="-">使用索引</h3>
<p>索引的意义在于，可以让你搜索任意字段，也就是说从任意字段拿到数据记录。如果不建立索引，默认只能搜索主键。</p>
<p>如果，新建表格的时候，对name字段建立了索引，就可以从name中找到对应的数据记录了。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">objectStore</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">unique</span><span class="o">:</span> <span class="kc">false</span> <span class="p">});</span>

<span class="kd">var</span> <span class="nx">transaction</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">([</span><span class="s1">&#39;person&#39;</span><span class="p">],</span> <span class="s1">&#39;readonly&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">transaction</span><span class="p">.</span><span class="nx">objectStore</span><span class="p">(</span><span class="s1">&#39;person&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">index</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;李四&#39;</span><span class="p">);</span>

<span class="nx">request</span><span class="p">.</span><span class="nx">onsuccess</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h1 id="mdn-">MDN的补充</h1>
<p>IndexedDB是一种让你在用户的浏览器内持久化存储数据的方法。IndexedDB为Web Application提供了丰富的查询能力，使得我们的应用在在线和离线时都可以正常工作。</p>
<p>IndexedDB的API被设计为尽可能地减少多错误处理的需求，所以你可能不会看到很多的错误事件。</p>
<h2 id="-">错误处理</h2>
<p>错误处理遵循冒泡机制，错误事件都是针对产生这些错误的请求的，然后事件冒泡到事务，然后最终到达数据库对象。</p>
<p>如果你希望避免为所有的请求都增加错误处理程序，你可以仅对数据库对象添加一个错误处理程序。</p>
<h2 id="-">更新数据库版本</h2>
<p>数据库会保留之前版本数据库的对象仓库，不必重建这些对象仓库。但是你需要创建新的对象仓库，或删除不再需要的对象仓库。如果你需要修改一个已存在的对象仓库，必须先删除原来的对象仓库，你需要在删除原对象仓库之前保存所有的信息。</p>
<h2 id="-">构建数据库</h2>
<p>IndexedDB使用对象仓库而不是表，并且一个单独的数据库可以包含任意数量的对象存储空间。每当一个值被存储进一个对象存储空间，它会被一个键相关联。</p>
<p>键的方式：</p>
<p>1、不使用KeyPath和AutoIncrement，这种对象存储空间可以持有任意类型的值，但是当增加一个新值得时候，必须提供一个单独的键参数。</p>
<p>2、使用keyPath，不使用键生成器(AutoIncrement)，只能持有JS对象，这些对象必须具有一个和key path同名的属性。</p>
<p>3、不使用keyPath，使用键生成器(AutoIncrement)，这种对象存储空间可以持有任意类型的值，键会为我们自动生成。或者使用一个单独的键参数。</p>
<p>4、使用KeyPath和键生成器(AutoIncrement)，这种对象只能持有JS对象，通常一个键被生成的同时，生成的键的值被存储在对象中的和keypath同名的属性中。如果属性存在，这个属性的值被用作键而不会生成一个新的键。</p>
<p>索引具有对存储的数据执行简单限制的能力。通过创建索引时候设置uniqe标记，索引可以确保不会有两个具有同样索引keyPath值的对象被存储。</p>
<p>键生成器生成的值从来不会减小，除非数据库操作结果被回滚。比如：数据库事务被中断。删除一条记录，甚至清空对象仓库里的所有记录都不会影响对象仓库的键生成器。</p>
<h2 id="-">增加、读取和删除数据</h2>
<p>需要开启一个事务才能对你创建的数据库进行操作。事务来自于数据库对象，你必须指定你想让这个事务跨越哪些对象仓库。事务提供了三种模式：1、readonly；2、readwrite；3、versionchange。</p>
<p>想要修改数据库模式或结构，包括新建或删除对象仓库或索引，只能在versionchange事务中才能实现。</p>
<p>可以通过使用合适的作用域和模式来加速数据库访问：</p>
<p>1、定义作用域时，只指定你用到的对象仓库。这样，你可以同时运行多个不包含互相重叠作用域的事务。</p>
<p>2、只在必要时指定readwrite事务。你可以同时执行多个readonly事务，哪怕它们的作用域有重叠。但对于在一个对象仓库上只能运行一个readwrite事务。</p>
<p>事务的生命周期：事务和事件循环的联系非常密切，如果你创建了一个事务但是没有使用它就返回给事件循环，那么事务将会失活。保持事务活跃的唯一方法就是在其上构建一个请求。</p>
<p>注意，如果事务成功了，你将有另外一个机会在回调中延长这个事务。如果你看到TRANSACTION_INACTIVE_ERR错误代码，那么你已经把某些事情搞乱了。</p>
<p>事务接收三种不同的DOM事件，error，abort和complete。error事件是冒泡机制，错误会中断它所处的事务，除非你第一时间调用了stopPropagation并执行了其它操作来处理错误，不然整个事务将会回滚。</p>
<p>在所有的事务完成后，事务的complete事件会被触发。如果你进行大量数据库操作，跟踪事务而不是具体的请求会使逻辑更加清晰。</p>
<h3 id="-">读取值</h3>
<p>简单的get方法，需要提供键来提取值。</p>
<h3 id="-">使用游标</h3>
<p>如果要遍历对象存储空间中的多个值，需要使用游标。openCursor函数需要几个参数，首先，你可以使用一个key range对象来限制被检索的项目的范围。第二，你可以指定希望进行迭代的方向。</p>
<p>游标本身是请求的result，如果想要继续前行，那么你必须调用游标上的continue()，当你达到数据的末尾时，result变为undefined。</p>
<p>查看游标的value属性会带来性能消耗，因为对象是被懒生成的。使用getAll，浏览器必须一次性创建所有的对象。如果想检索m键，游标要比getAll高效很多。当然如果你想获取一个由对象仓库中所有对象组成的数组，请使用getAll。</p>
<h3 id="-">使用索引</h3>
<p>索引如果使用get，总是会得到键值最小的那个。你可以在索引上打开两个不同类型的游标，一个常规游标(openCursor)映射索引属性到对象存储空间中的对象。一个键索引属性(openKeyCursor)被用来存储对象存储空间中的对象的键。</p>
<h3 id="-">指定游标的范围和方向</h3>
<p>如果你想要限定你在游标中看到的值的范围，你可以使用一个key range对象作为参数传给openCursor或openKeyCursor。</p>
<p>你可以构建一个只允许一个单一key的key range，或者一个具有下限或上限，或者一个既有上限又有下限。边界可以是闭合的，也可以是开放的。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">singleKeyRange</span> <span class="o">=</span> <span class="nx">IDBKeyRange</span><span class="p">.</span><span class="nx">only</span><span class="p">(</span><span class="s2">&quot;Donna&quot;</span><span class="p">);</span>
<span class="c1">// 包括Bill，大于Bill的所有值</span>
<span class="kd">var</span> <span class="nx">lowerBoundKeyRange</span> <span class="o">=</span> <span class="nx">IDBKeyRange</span><span class="p">.</span><span class="nx">lowerBound</span><span class="p">(</span><span class="s2">&quot;Bill&quot;</span><span class="p">);</span>
<span class="c1">// 不包括Bill</span>
<span class="kd">var</span> <span class="nx">lowerBoundOpenKeyRange</span> <span class="o">=</span> <span class="nx">IDBKeyRange</span><span class="p">.</span><span class="nx">lowerBound</span><span class="p">(</span><span class="s2">&quot;Bill&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="c1">// 不包括Donna</span>
<span class="kd">var</span> <span class="nx">upperBoundOpenKeyRange</span> <span class="o">=</span> <span class="nx">IDBKeyRange</span><span class="p">.</span><span class="nx">upperBound</span><span class="p">(</span><span class="s2">&quot;Donna&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="c1">// 在Bill和Donna之间，不包括Donna</span>
<span class="kd">var</span> <span class="nx">boundKeyRange</span> <span class="o">=</span> <span class="nx">IDBKeyRange</span><span class="p">.</span><span class="nx">bound</span><span class="p">(</span><span class="s2">&quot;Bill&quot;</span><span class="p">,</span> <span class="s2">&quot;Donna&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</pre></div>

</code></pre>
<p>有时候，你想要以倒序而不是正序来遍历，切换方向是通过传递prev到openCursor方法来实现的。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">objectStore</span><span class="p">.</span><span class="nx">openCursor</span><span class="p">(</span><span class="nx">boundKeyRange</span><span class="p">,</span> <span class="s2">&quot;prev&quot;</span><span class="p">)</span>
</pre></div>

</code></pre>
<p>如果你只想改变遍历的方向，而不想对结果进行筛选，你只需要给第一个参数传入null。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">objectStore</span><span class="p">.</span><span class="nx">openCursor</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;prev&quot;</span><span class="p">)</span>
</pre></div>

</code></pre>
<p>如果你想要在游标在索引过程中过滤除重复的，你可以传入nextunique，或prevunique作为方向参数。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">index</span><span class="p">.</span><span class="nx">openKeyCursor</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">IDBCursor</span><span class="p">.</span><span class="nx">nextunique</span><span class="p">)</span>
</pre></div>

</code></pre>
<h2 id="-webapp-">当一个webApp在另一个标签页中被打开时的版本变更</h2>
<p>当你使用更高的版本号调用open方法时，其它所有打开的数据库必须显式地确认请求，你才能对数据库进行修改。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">openReq</span><span class="p">.</span><span class="nx">onblocked</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 如果其他的一些页签加载了该数据库，在我们继续之前需要关闭它们</span>
  <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;请关闭其他由该站点打开的页签！&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">useDatabase</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 当由其他页签请求了版本变更时，确认添加了一个会被通知的事件处理程序。</span>
  <span class="c1">// 这里允许其他页签来更新数据库，如果不这样做，版本升级将不会发生知道用户关闭了这些页签。</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">onversionchange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;A new version of this page is ready. Please reload or close this tab!&quot;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="c1">// 处理数据库</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h2 id="-">浏览器关闭警告</h2>
<p>浏览器关闭，或包含数据库的磁盘被意外移除，或数据库存储的权限丢失，将发生以下问题：</p>
<p>1、受影响的数据库的所有事务会以AbortError错误中断。该影响和在每个事务中调用IDBTransaction.abort相同。</p>
<p>2、所有的事务完成后，数据库连接就会关闭。</p>
<p>3、最终，表示数据库连接的IDBDatabse对象收到一个close事件，你可以使用IDBDatabase.onclose事件句柄俩监听这些事件。</p>
<p>在firefox50，google chrome 31发行版之前的浏览器，事务会静默中断，并且close事件不会触发。</p>
<p>你应该始终使数据库在事务结束时处于一个稳定的状态。eg：你执行一个清空数据，然后写入数据的操作。为了避免数据丢失，应该在同一个事务中执行清空数据和写入数据。</p>
<p>不应该把数据库事务绑定到卸载事件上。如果卸载事务由浏览器关闭所触发，卸载事件处理函数中的任何事务都不会完成。由于数据库事务是异步的，可能在它们执行之前就会被中断。</p>
<h1 id="indexeddb-">IndexedDB的关键特性</h1>
<p>1、IndexedDB存储key-value键值对。value可以是复杂的结构化对象，key可以是这个对象的属性。</p>
<p>2、IndexedDB基于事务数据库模型构建。所有在IndexedDB中的操作都发生在事务的上下文中。</p>
<p>3、IndexedDB的API主要是异步的。</p>
<p>4、IndexedDB使用了大量的Request。Request是接收成功或失败的DOM事件的对象。Request的result的值类型取决于Request的类型。可能是Cursor，可能是DB，可能是普通的对象。</p>
<p>5、IndexedDB使用DOM事件来通知你，结果已经可用。success事件不会冒泡，也不能取消。error事件是冒泡的，可被取消。</p>
<p>6、IndexedDB是面向对象的。IndexedDB不是有很多表的关系型数据库。IndexedDB创建对象仓库，然后持久化JS对象到对象仓库中。每一个对象仓库有一系列的索引让查询和遍历更有效率。</p>
<p>7、IndexedDB不使用SQL。</p>
<p>8、IndexedDB使用上遵循同源策略。</p>
<h2 id="-">限制</h2>
<p>IndexedDB不能覆盖的一些场景。</p>
<p>1、国际化地排序。并不是所有语言都遵循相同的排序规则。新版本的浏览器开始部分支持该功能。</p>
<p>2、同步调用。API没有为服务器端的数据库使用场景设计同步API。</p>
<p>3、全文搜索。API并没有提供like类的操作符。</p>
<h2 id="-">浏览器清空数据的场景</h2>
<p>1、用户请求清空特定网站的数据。</p>
<p>2、无痕模式，在会话结束后会被清空。</p>
<p>3、存储空间配额不够。</p>
<p>4、数据格式不正确。</p>
<p>5、浏览器的破坏性更新。</p>
<h2 id="-">关键术语</h2>
<h3 id="databse">databse</h3>
<p>包括多个Object Stores，每一个Database包含name和version。</p>
<p>databse连接，open database创建的，一个给定的database可以同时有多个连接。</p>
<h3 id="index">index</h3>
<p>一个索引是一个为查找另一个对象仓库中的记录专用的对象仓库。索引是一个持久化的key-value存储。value的值是另一个对象仓库的key值。</p>
<p>当引用的对象仓库的数据被插入，更新或删除时候，浏览器去自动去维护索引对象仓库。</p>
<h3 id="object-store">object store</h3>
<p>保存键值对记录，以key值升序存储。在database内name必须唯一，可以指定一个键生成器或keyPath。</p>
<h3 id="request">request</h3>
<p>读写数据库操作返回的请求。</p>
<h3 id="transaction">transaction</h3>
<p>在一个数据库上原子性的数据读取和数据修改操作。</p>
<p>一个database连接可以同时有多个活动中的事务，只要这些写事务没有重合的scope。</p>
<p>事务的生命应该是短暂的，浏览器为了释放存储资源，会停止耗时长的事务。</p>
<p>你可以调用事务的abort方法来手动放弃事务，这样数据会回滚。</p>
<h3 id="version">version</h3>
<p>每一个数据库在某一时刻只能有一个版本，数据库不能多版本共存。</p>
<h2 id="key-and-value">key and value</h2>
<h3 id="in-line-key">in-line key</h3>
<p>keypath方式指定的key。也可以使用key生成器来生成，然后设置到对象的keypath属性上。</p>
<h3 id="key">key</h3>
<p>用来组织和检索数据，key在object store中必须唯一。</p>
<p>key的类型可以是string，date，float，二进制blob，数组。</p>
<h3 id="key-generator-key-path">key generator &amp; key path</h3>
<p>key generator：一种按顺序生成新值的机制。</p>
<p>key path：从哪个属性提取key。</p>
<h3 id="value">value</h3>
<p>可以包括JS里面的几乎所有对象。包括boolean，number，string，date，object，array，regexp，undefined和null。Blobs和files也可以存储。</p>
<h2 id="range-scope">Range &amp; scope</h2>
<h3 id="cursor">cursor</h3>
<p>一种根据key界限遍历多条记录的机制。Cursor有数据源记录遍历的Index或Store，记录当前Range中的位置，记录移动方向的属性。</p>
<h3 id="key-range">key range</h3>
<p>key的区间表示，包含上限和下限。</p>
<h3 id="scope">scope</h3>
<p>事务作用于的object store或index。如果是readwrtie事务，且有重叠的作用域，它们会按次序依次执行。</p>
<h2 id="-">扩展阅读</h2>
<h3 id="-">结构化克隆算法</h3>
<p>结构化克隆算法主要是拷贝复杂的JS对象。当你调用structuredClone，在线程之间postMessage，使用IndexedDB存储对象时，会被JS引擎隐式调用。</p>
<p>它通过遍历输入对象，通过维护之前访问过的属性值来避免循环引用错误。</p>
<h4 id="-">不能克隆的数据类型</h4>
<p>1、Function对象不能克隆，会报DataCloneError的异常。</p>
<p>2、DOM节点也不能克隆，会报DataCloneError的异常。</p>
<p>3、不会保留的节点：RegExp的lastIndex节点；对象的属性描述符，setters &amp; getters和其它类似的描述信息，原型链不会被克隆。</p>
<h4 id="-">可以支持的数据类型</h4>
<p>基本类型，Boolean对象，String对象，Date，RegExp，Blob，File，FileList，ArrayBuffer，ArrayBufferView，ImageBiteMap，ImageData，Array，Object，Map，Set。</p>
<h2 id="-">参考文档</h2>
<p><a href="http://www.ruanyifeng.com/blog/2018/07/indexeddb.html">http://www.ruanyifeng.com/blog/2018/07/indexeddb.html</a></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API/Using_IndexedDB">https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API/Using_IndexedDB</a></p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Basic_Terminology">https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Basic_Terminology</a></p>
</body>
</html>
