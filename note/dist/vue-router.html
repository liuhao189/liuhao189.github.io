<!DOCTYPE html>
<html>
<head>
  <title>Vue-Router原理</title>
  <link rel="stylesheet" href="/note/note.css?ts=1645290074658">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"><link rel="shortcut icon" href="/ico.png"></head>
<body><script>var _hmt = _hmt || [];
(function () {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?256376ad73e3e50091706bb3c032e74c";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>
<h1 id="vue-router-">Vue-Router原理</h1>
<h2 id="-">前端路由</h2>
<p>单页应用中，页面的跳转是无刷新的，为了实现这种效果，需要使用前端路由。</p>
<p>类似于服务器端路由，前端路由实现起来大概就是匹配不同的url路径，进行解析，然后动态渲染出区域的HTML内容。</p>
<h3 id="hash-">hash模式</h3>
<p>URL的#后面的值的变化，并不会导致浏览器向服务器发出请求，也就不会刷新页面。每次hash值的变化，还会触发hashchange这个事件。</p>
<h3 id="history-">history模式</h3>
<p>14年后，因为HTML5标准发布，多了两个API，pushState和replaceState，通过这两个API可以改变url地址且不会发送请求。同时还有popState事件，通过这些就能用另一种方式来实现前端路由。</p>
<p>跟hash模式不同，history模式需要服务器配合，将前端路由覆盖的请求都返回单页的html文档。</p>
<h2 id="vue-router-">Vue-Router的使用</h2>
<p>使用代码：</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">import</span> <span class="nx">VueRouter</span> <span class="nx">from</span> <span class="s1">&#39;vue-router&#39;</span>
<span class="nx">Vue</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">VueRouter</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">VueRouter</span><span class="p">({</span>
  <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;history&#39;</span><span class="p">,</span>
  <span class="nx">routes</span><span class="o">:</span> <span class="p">[...]</span>
<span class="p">})</span>

<span class="k">new</span> <span class="nx">Vue</span><span class="p">({</span>
  <span class="nx">router</span>
  <span class="p">...</span>
<span class="p">})</span>
</pre></div>

</code></pre>
<p>首先，使用了Vue.use安装了VueRouter这个插件。然后new VueRouter来实例化一个VueRouter对象。最后，将实例化的对象router添加到根Vue组件的options中。</p>
<h2 id="vue-router-install-">Vue-router实现之install方法</h2>
<p>Vue通过use方法，加载VueRouter中的install方法。下面来看一下具体的执行过程。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">export</span> <span class="kd">let</span> <span class="nx">_Vue</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">install</span> <span class="p">(</span><span class="nx">Vue</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//首先判断是否在当前Vue对象中安装过，if 安装过，直接返回</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">install</span><span class="p">.</span><span class="nx">installed</span> <span class="o">&amp;&amp;</span> <span class="nx">_Vue</span> <span class="o">===</span> <span class="nx">Vue</span><span class="p">)</span> <span class="k">return</span>
  <span class="nx">install</span><span class="p">.</span><span class="nx">installed</span> <span class="o">=</span> <span class="kc">true</span>

  <span class="nx">_Vue</span> <span class="o">=</span> <span class="nx">Vue</span>

  <span class="kr">const</span> <span class="nx">isDef</span> <span class="o">=</span> <span class="nx">v</span> <span class="o">=&gt;</span> <span class="nx">v</span> <span class="o">!==</span> <span class="kc">undefined</span>

  <span class="kr">const</span> <span class="nx">registerInstance</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vm</span><span class="p">,</span> <span class="nx">callVal</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">$options</span><span class="p">.</span><span class="nx">_parentVnode</span>
    <span class="c1">// 通过registerRouteInstance方法来实现对router-view的挂载操作</span>
    <span class="c1">// 因为只有router-view定义了data.registerRouteInstance函数</span>
    <span class="c1">// registerRouteInstance主要用来执行render操作。</span>
    <span class="c1">// data.registerRouteInstance = (vm, val) =&gt; {</span>
    <span class="c1">// ...</span>
    <span class="c1">//    return h(component, data, children)</span>
    <span class="c1">//  }</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isDef</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">isDef</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">isDef</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">registerRouteInstance</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">i</span><span class="p">(</span><span class="nx">vm</span><span class="p">,</span> <span class="nx">callVal</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">Vue</span><span class="p">.</span><span class="nx">mixin</span><span class="p">({</span>
    <span class="nx">beforeCreate</span> <span class="p">()</span> <span class="p">{</span>
      <span class="c1">// 如果定义了router属性，说明是根组件</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isDef</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$options</span><span class="p">.</span><span class="nx">router</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_routerRoot</span> <span class="o">=</span> <span class="k">this</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_router</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$options</span><span class="p">.</span><span class="nx">router</span>
        <span class="c1">//执行router的init方法</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_router</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="c1">//为Vue根组件设置_route属性</span>
        <span class="nx">Vue</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">defineReactive</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;_route&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_router</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">//不是根组件则直接取父组件的_routerRoot</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_routerRoot</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$parent</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">$parent</span><span class="p">.</span><span class="nx">_routerRoot</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span>
      <span class="p">}</span>
      <span class="nx">registerInstance</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nx">destroyed</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">registerInstance</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="c1">// 设置代理 当访问$router时，代理到this._routerRoot._router</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s1">&#39;$router&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">get</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_routerRoot</span><span class="p">.</span><span class="nx">_router</span> <span class="p">}</span>
  <span class="p">})</span>
  <span class="c1">// 设置代理，当访问$route时，代理到 this._routerRoot._route</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s1">&#39;$route&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">get</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_routerRoot</span><span class="p">.</span><span class="nx">_route</span> <span class="p">}</span>
  <span class="p">})</span>
  <span class="c1">//注册RouterView和RouterLink组件</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">component</span><span class="p">(</span><span class="s1">&#39;RouterView&#39;</span><span class="p">,</span> <span class="nx">View</span><span class="p">)</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">component</span><span class="p">(</span><span class="s1">&#39;RouterLink&#39;</span><span class="p">,</span> <span class="nx">Link</span><span class="p">)</span>

  <span class="c1">// Vue钩子合并策略 同created</span>
  <span class="kr">const</span> <span class="nx">strats</span> <span class="o">=</span> <span class="nx">Vue</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">optionMergeStrategies</span>
  <span class="c1">// use the same hook merging strategy for route hooks</span>
  <span class="nx">strats</span><span class="p">.</span><span class="nx">beforeRouteEnter</span> <span class="o">=</span> <span class="nx">strats</span><span class="p">.</span><span class="nx">beforeRouteLeave</span> <span class="o">=</span> <span class="nx">strats</span><span class="p">.</span><span class="nx">beforeRouteUpdate</span> <span class="o">=</span> <span class="nx">strats</span><span class="p">.</span><span class="nx">created</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>整体上install方法：</p>
<p>1、判断是否安装过Vue-Router，安装过，直接返回。</p>
<p>2、Vue.mixin beforeCreate(主要设置_routerRoot和_route，根组件时初始化router)和destoryed生命周期。</p>
<p>3、定义Vue.prototype上的$router和$route属性，返回上面定义的_routerRoot和_route。</p>
<p>4、注册RouterView和RouteLink组件。</p>
<p>5、设置Router添加的生命周期的合并策略，和created一样，最终可能是个数组。</p>
<h2 id="vue-router-new-router-options-">vue-router实现之new Router(options)</h2>
<p>VueRouter实例化代码：</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">VueRouter</span><span class="p">({</span>
  <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;history&#39;</span><span class="p">,</span>
  <span class="nx">routes</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="nx">component</span><span class="o">:</span> <span class="nx">Home</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/foo&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="nx">component</span><span class="o">:</span> <span class="nx">Foo</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/bar/:id&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="nx">component</span><span class="o">:</span> <span class="nx">Bar</span> <span class="p">}</span>
  <span class="p">]</span>
<span class="p">})</span>
</pre></div>

</code></pre>
<p>VueRouter类的构造方法：</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">VueRouter</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="nx">constructor</span> <span class="p">(</span><span class="nx">options</span><span class="o">:</span> <span class="nx">RouterOptions</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">apps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">beforeHooks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">resolveHooks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">afterHooks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span> <span class="o">=</span> <span class="nx">createMatcher</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">routes</span> <span class="o">||</span> <span class="p">[],</span> <span class="k">this</span><span class="p">)</span>

    <span class="c1">//默认为hash mode</span>
    <span class="kd">let</span> <span class="nx">mode</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">mode</span> <span class="o">||</span> <span class="s1">&#39;hash&#39;</span>
    <span class="c1">// 如果指定为history，但是浏览器不支持pushState，且options.fallback为true，则fallback到hash</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">fallback</span> <span class="o">=</span>
      <span class="nx">mode</span> <span class="o">===</span> <span class="s1">&#39;history&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">supportsPushState</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">fallback</span> <span class="o">!==</span> <span class="kc">false</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fallback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">mode</span> <span class="o">=</span> <span class="s1">&#39;hash&#39;</span>
    <span class="p">}</span>
    <span class="c1">// 不在浏览器中，mode为abstract</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">inBrowser</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">mode</span> <span class="o">=</span> <span class="s1">&#39;abstract&#39;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="nx">mode</span>

    <span class="k">switch</span> <span class="p">(</span><span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;history&#39;</span><span class="o">:</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">history</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HTML5History</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">base</span><span class="p">)</span>
        <span class="k">break</span>
      <span class="k">case</span> <span class="s1">&#39;hash&#39;</span><span class="o">:</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">history</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HashHistory</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">base</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">fallback</span><span class="p">)</span>
        <span class="k">break</span>
      <span class="k">case</span> <span class="s1">&#39;abstract&#39;</span><span class="o">:</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">history</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AbstractHistory</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">base</span><span class="p">)</span>
        <span class="k">break</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="err">`</span><span class="nx">invalid</span> <span class="nx">mode</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">mode</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>上一个章节提到，VueRouter的install方法会调用VueRouter.init方法</p>
<p>VueRouter的实例方法init：</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// app为根Vue组件</span>
<span class="nx">init</span> <span class="p">(</span><span class="nx">app</span><span class="o">:</span> <span class="nx">any</span> <span class="cm">/* Vue component instance */</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">apps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
    <span class="c1">// 如果this.app有值，说明init过，直接返回即可</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span>
    <span class="kr">const</span> <span class="nx">history</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">history</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">history</span> <span class="k">instanceof</span> <span class="nx">HTML5History</span> <span class="o">||</span> <span class="nx">history</span> <span class="k">instanceof</span> <span class="nx">HashHistory</span><span class="p">)</span> <span class="p">{</span>

      <span class="kr">const</span> <span class="nx">handleInitialScroll</span> <span class="o">=</span> <span class="nx">routeOrError</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// 处理滚动位置的，暂时忽略</span>
      <span class="p">}</span>

      <span class="kr">const</span> <span class="nx">setupListeners</span> <span class="o">=</span> <span class="nx">routeOrError</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">history</span><span class="p">.</span><span class="nx">setupListeners</span><span class="p">()</span>
        <span class="nx">handleInitialScroll</span><span class="p">(</span><span class="nx">routeOrError</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="c1">//</span>
      <span class="nx">history</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span>
        <span class="nx">history</span><span class="p">.</span><span class="nx">getCurrentLocation</span><span class="p">(),</span>
        <span class="nx">setupListeners</span><span class="p">,</span>
        <span class="nx">setupListeners</span>
      <span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">history</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">route</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">//route更新后，所有app._route都更新到新的route</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">apps</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">app</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">_route</span> <span class="o">=</span> <span class="nx">route</span>
      <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">}</span>
</pre></div>

</code></pre>
<p>init方法主要执行了history.transitionTo和history.listen方法来改变app._route。</p>
<h2 id="vuerouter-hashhistory">VueRouter实现之HashHistory</h2>
<p>hash模式使用得比较多，让我们先来看下HashHistory的实现。</p>
<p>上文构造函数章节，我们得知mode为hash时，会执行下面的代码。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// this为router实例，options.base为基础path，fallback为是否降级到hash模式</span>
<span class="k">this</span><span class="p">.</span><span class="nx">history</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HashHistory</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">base</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">fallback</span><span class="p">)</span>
</pre></div>

</code></pre>
<p>HashHistory构造方法：</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">export</span> <span class="kr">class</span> <span class="nx">HashHistory</span> <span class="kr">extends</span> <span class="nx">History</span> <span class="p">{</span>
  <span class="nx">constructor</span> <span class="p">(</span><span class="nx">router</span><span class="o">:</span> <span class="nx">Router</span><span class="p">,</span> <span class="nx">base</span><span class="o">:</span> <span class="o">?</span><span class="nx">string</span><span class="p">,</span> <span class="nx">fallback</span><span class="o">:</span> <span class="kr">boolean</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 基类构造器</span>
    <span class="kr">super</span><span class="p">(</span><span class="nx">router</span><span class="p">,</span> <span class="nx">base</span><span class="p">)</span>
    <span class="c1">// check history fallback deeplinking </span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fallback</span> <span class="o">&amp;&amp;</span> <span class="nx">checkFallback</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="c1">//保证hash以/开头</span>
    <span class="nx">ensureSlash</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 将history模式转换为hash模式</span>
<span class="kd">function</span> <span class="nx">checkFallback</span> <span class="p">(</span><span class="nx">base</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">location</span> <span class="o">=</span> <span class="nx">getLocation</span><span class="p">(</span><span class="nx">base</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/^\/#/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">location</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">cleanPath</span><span class="p">(</span><span class="nx">base</span> <span class="o">+</span> <span class="s1">&#39;/#&#39;</span> <span class="o">+</span> <span class="nx">location</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">ensureSlash</span> <span class="p">()</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">getHash</span><span class="p">()</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span>
  <span class="p">}</span>
  <span class="nx">replaceHash</span><span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">)</span>
  <span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">replaceHash</span> <span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">supportsPushState</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">replaceState</span><span class="p">(</span><span class="nx">getUrl</span><span class="p">(</span><span class="nx">path</span><span class="p">))</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">getUrl</span><span class="p">(</span><span class="nx">path</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">getHash</span> <span class="p">()</span><span class="o">:</span> <span class="nx">string</span> <span class="p">{</span>
  <span class="c1">// We can&#39;t use window.location.hash here because it&#39;s not</span>
  <span class="c1">// consistent across browsers - Firefox will pre-decode it!</span>
  <span class="kd">let</span> <span class="nx">href</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span>
  <span class="kr">const</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
  <span class="c1">// empty path</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span>
  <span class="nx">href</span> <span class="o">=</span> <span class="nx">href</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">href</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>HashHistory构造函数初始化时：</p>
<p>1、针对不支持history模式的降级处理。</p>
<p>2、保证hash值是以/开头的。注意hash模式在支持pushState的浏览器中也是使用pushState改变的hash值。</p>
<h3 id="transitionto-">transitionTo方法</h3>
<p>init方法中调用了history实例的transitionTo方法。</p>
<p>transitionTo方法源码：</p>
<pre><code class="lang-js"><div class="highlight"><pre>  <span class="nx">transitionTo</span> <span class="p">(</span>
    <span class="nx">location</span><span class="o">:</span> <span class="nx">RawLocation</span><span class="p">,</span>
    <span class="nx">onComplete</span><span class="o">?:</span> <span class="nb">Function</span><span class="p">,</span>
    <span class="nx">onAbort</span><span class="o">?:</span> <span class="nb">Function</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">route</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="c1">//location为当前的hash值，this.current在构造函数中赋值为createRoute(null, { path: &#39;/&#39;})</span>
      <span class="nx">route</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span>
      <span class="c1">//match代码在下面</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">errorCbs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">cb</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">cb</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
      <span class="p">})</span>
      <span class="c1">// Exception should still be thrown</span>
      <span class="k">throw</span> <span class="nx">e</span>
    <span class="p">}</span>
    <span class="kr">const</span> <span class="nx">prev</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">confirmTransition</span><span class="p">(</span>
      <span class="nx">route</span><span class="p">,</span>
      <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">updateRoute</span><span class="p">(</span><span class="nx">route</span><span class="p">)</span>
        <span class="nx">onComplete</span> <span class="o">&amp;&amp;</span> <span class="nx">onComplete</span><span class="p">(</span><span class="nx">route</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">ensureURL</span><span class="p">()</span>
        <span class="c1">//导航成功，执行afterHooks的回调</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">afterHooks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">hook</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">hook</span> <span class="o">&amp;&amp;</span> <span class="nx">hook</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">prev</span><span class="p">)</span>
        <span class="p">})</span>

        <span class="c1">// 第一次导航成功，调ready相关的回调</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ready</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">true</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">readyCbs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">cb</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">cb</span><span class="p">(</span><span class="nx">route</span><span class="p">)</span>
          <span class="p">})</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">onAbort</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">onAbort</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1">//有错误，没有ready过，调readyError相关的回调</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ready</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isNavigationFailure</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">NavigationFailureType</span><span class="p">.</span><span class="nx">redirected</span><span class="p">)</span> <span class="o">||</span> <span class="nx">prev</span> <span class="o">!==</span> <span class="nx">START</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">true</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">readyErrorCbs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">cb</span> <span class="o">=&gt;</span> <span class="p">{</span>
              <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="p">})</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">)</span>
  <span class="p">}</span>
</pre></div>

</code></pre>
<p>下面代码执行时，返回了route。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">route</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span>
</pre></div>

</code></pre>
<p>this.current是什么？别急，让我们看一下this.current的赋值语句。</p>
<pre><code class="lang-js"><div class="highlight"><pre>  <span class="c1">// the starting route that represents the initial state</span>
  <span class="kr">export</span> <span class="kr">const</span> <span class="nx">START</span> <span class="o">=</span> <span class="nx">createRoute</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span>
  <span class="p">})</span>

  <span class="nx">constructor</span> <span class="p">(</span><span class="nx">router</span><span class="o">:</span> <span class="nx">Router</span><span class="p">,</span> <span class="nx">base</span><span class="o">:</span> <span class="o">?</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// start with a route object that stands for &quot;nowhere&quot;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">START</span>
  <span class="p">}</span>
</pre></div>

</code></pre>
<p>可以看到this.current是在History构造的时候赋值为一个代表初始route的对象。这个route对象是通过createRoute创建的。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createRoute</span> <span class="p">(</span>
  <span class="nx">record</span><span class="o">:</span> <span class="o">?</span><span class="nx">RouteRecord</span><span class="p">,</span>
  <span class="nx">location</span><span class="o">:</span> <span class="nx">Location</span><span class="p">,</span>
  <span class="nx">redirectedFrom</span><span class="o">?:</span> <span class="o">?</span><span class="nx">Location</span><span class="p">,</span>
  <span class="nx">router</span><span class="o">?:</span> <span class="nx">VueRouter</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">Route</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">stringifyQuery</span> <span class="o">=</span> <span class="nx">router</span> <span class="o">&amp;&amp;</span> <span class="nx">router</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">stringifyQuery</span>

  <span class="kd">let</span> <span class="nx">query</span><span class="o">:</span> <span class="nx">any</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">query</span> <span class="o">||</span> <span class="p">{}</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">//深度赋值，以免被修改</span>
    <span class="nx">query</span> <span class="o">=</span> <span class="nx">clone</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kr">const</span> <span class="nx">route</span><span class="o">:</span> <span class="nx">Route</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="nx">location</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="p">(</span><span class="nx">record</span> <span class="o">&amp;&amp;</span> <span class="nx">record</span><span class="p">.</span><span class="nx">name</span><span class="p">),</span>
    <span class="nx">meta</span><span class="o">:</span> <span class="p">(</span><span class="nx">record</span> <span class="o">&amp;&amp;</span> <span class="nx">record</span><span class="p">.</span><span class="nx">meta</span><span class="p">)</span> <span class="o">||</span> <span class="p">{},</span>
    <span class="nx">path</span><span class="o">:</span> <span class="nx">location</span><span class="p">.</span><span class="nx">path</span> <span class="o">||</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
    <span class="nx">hash</span><span class="o">:</span> <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="nx">query</span><span class="p">,</span>
    <span class="nx">params</span><span class="o">:</span> <span class="nx">location</span><span class="p">.</span><span class="nx">params</span> <span class="o">||</span> <span class="p">{},</span>
    <span class="nx">fullPath</span><span class="o">:</span> <span class="nx">getFullPath</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="nx">stringifyQuery</span><span class="p">),</span>
    <span class="nx">matched</span><span class="o">:</span> <span class="nx">record</span> <span class="o">?</span> <span class="nx">formatMatch</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span> <span class="o">:</span> <span class="p">[]</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">redirectedFrom</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">route</span><span class="p">.</span><span class="nx">redirectedFrom</span> <span class="o">=</span> <span class="nx">getFullPath</span><span class="p">(</span><span class="nx">redirectedFrom</span><span class="p">,</span> <span class="nx">stringifyQuery</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">//冻结route对象</span>
  <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nx">route</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>可以看到createRoute主要根据record（vue路由我们定义的对象扩展出来的对象）和location（根据location的解析结构）对象构造出来的route对象。</p>
<p>接着我们看下this.router.match方法，该方法应该返回现在匹配的route。</p>
<pre><code class="lang-js"><div class="highlight"><pre>  <span class="nx">match</span> <span class="p">(</span><span class="nx">raw</span><span class="o">:</span> <span class="nx">RawLocation</span><span class="p">,</span> <span class="nx">current</span><span class="o">?:</span> <span class="nx">Route</span><span class="p">,</span> <span class="nx">redirectedFrom</span><span class="o">?:</span> <span class="nx">Location</span><span class="p">)</span><span class="o">:</span> <span class="nx">Route</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">redirectedFrom</span><span class="p">)</span>
  <span class="p">}</span>
</pre></div>

</code></pre>
<p>可以看到router.match主要是转调this.matcher的match方法。</p>
<p>matcher对象是通过createMatcher方法生成的，下面看下createMatcher的源码。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createMatcher</span> <span class="p">(</span>
  <span class="nx">routes</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">RouteConfig</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">router</span><span class="o">:</span> <span class="nx">VueRouter</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">Matcher</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="kd">function</span> <span class="nx">match</span> <span class="p">(</span>
    <span class="nx">raw</span><span class="o">:</span> <span class="nx">RawLocation</span><span class="p">,</span>
    <span class="nx">currentRoute</span><span class="o">?:</span> <span class="nx">Route</span><span class="p">,</span>
    <span class="nx">redirectedFrom</span><span class="o">?:</span> <span class="nx">Location</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">Route</span> <span class="p">{</span>
    <span class="c1">//解析当前url，得到hash，path，query和name等信息</span>
    <span class="kr">const</span> <span class="nx">location</span> <span class="o">=</span> <span class="nx">normalizeLocation</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="nx">currentRoute</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">router</span><span class="p">)</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">name</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">location</span>
    <span class="c1">// location有name，这种情况是从currentRoute来的，不能从url里解析出name</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">record</span> <span class="o">=</span> <span class="nx">nameMap</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">record</span><span class="p">)</span> <span class="k">return</span> <span class="nx">_createRoute</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">location</span><span class="p">)</span>

      <span class="c1">// 找到必须的params names</span>
      <span class="kr">const</span> <span class="nx">paramNames</span> <span class="o">=</span> <span class="nx">record</span><span class="p">.</span><span class="nx">regex</span><span class="p">.</span><span class="nx">keys</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="nx">key</span><span class="p">.</span><span class="nx">optional</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="nx">key</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">location</span><span class="p">.</span><span class="nx">params</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">location</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">currentRoute</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">currentRoute</span><span class="p">.</span><span class="nx">params</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">currentRoute</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// 复制currentRoute中的params参数(如果不在location.params)中</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">location</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">paramNames</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">location</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">currentRoute</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="nx">location</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">fillParams</span><span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">location</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span> <span class="err">`</span><span class="nx">named</span> <span class="nx">route</span> <span class="s2">&quot;${name}&quot;</span><span class="err">`</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">_createRoute</span><span class="p">(</span><span class="nx">record</span><span class="p">,</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">redirectedFrom</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//</span>
      <span class="nx">location</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="c1">//遍历pathList，找到合适的的record，如果matchRoute，则直接根据record和location创建路由</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">pathList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">pathList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="kr">const</span> <span class="nx">record</span> <span class="o">=</span> <span class="nx">pathMap</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">matchRoute</span><span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">regex</span><span class="p">,</span> <span class="nx">location</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">location</span><span class="p">.</span><span class="nx">params</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">_createRoute</span><span class="p">(</span><span class="nx">record</span><span class="p">,</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">redirectedFrom</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// no match</span>
    <span class="k">return</span> <span class="nx">_createRoute</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">location</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>这里可能需要理解一下pathList，pathMap和nameMap这几个变量，它们是通过createRouteMap来创建的。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createRouteMap</span> <span class="p">(</span>
  <span class="nx">routes</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">RouteConfig</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">oldPathList</span><span class="o">?:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">oldPathMap</span><span class="o">?:</span> <span class="nx">Dictionary</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">oldNameMap</span><span class="o">?:</span> <span class="nx">Dictionary</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">parentRoute</span><span class="o">?:</span> <span class="nx">RouteRecord</span>
<span class="p">)</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">pathList</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">pathMap</span><span class="o">:</span> <span class="nx">Dictionary</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">nameMap</span><span class="o">:</span> <span class="nx">Dictionary</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span>
<span class="p">}</span> <span class="p">{</span>
  <span class="c1">// the path list is used to control path matching priority</span>
  <span class="kr">const</span> <span class="nx">pathList</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">oldPathList</span> <span class="o">||</span> <span class="p">[]</span>
  <span class="c1">// $flow-disable-line</span>
  <span class="kr">const</span> <span class="nx">pathMap</span><span class="o">:</span> <span class="nx">Dictionary</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">oldPathMap</span> <span class="o">||</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
  <span class="c1">// $flow-disable-line</span>
  <span class="kr">const</span> <span class="nx">nameMap</span><span class="o">:</span> <span class="nx">Dictionary</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">oldNameMap</span> <span class="o">||</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>

  <span class="nx">routes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">route</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">//定义的route传递给addRouteRecord</span>
    <span class="nx">addRouteRecord</span><span class="p">(</span><span class="nx">pathList</span><span class="p">,</span> <span class="nx">pathMap</span><span class="p">,</span> <span class="nx">nameMap</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">parentRoute</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="c1">// 确保 * 号的放到最后匹配</span>
  <span class="c1">// ensure wildcard routes are always at the end</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">pathList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pathList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">pathList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pathList</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
      <span class="nx">l</span><span class="o">--</span>
      <span class="nx">i</span><span class="o">--</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">pathList</span><span class="p">,</span>
    <span class="nx">pathMap</span><span class="p">,</span>
    <span class="nx">nameMap</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// addRouteRecord源码 </span>
<span class="kd">function</span> <span class="nx">addRouteRecord</span> <span class="p">(</span>
  <span class="nx">pathList</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">pathMap</span><span class="o">:</span> <span class="nx">Dictionary</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">nameMap</span><span class="o">:</span> <span class="nx">Dictionary</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">route</span><span class="o">:</span> <span class="nx">RouteConfig</span><span class="p">,</span>
  <span class="nx">parent</span><span class="o">?:</span> <span class="nx">RouteRecord</span><span class="p">,</span>
  <span class="nx">matchAs</span><span class="o">?:</span> <span class="nx">string</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">name</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">route</span>

  <span class="kr">const</span> <span class="nx">pathToRegexpOptions</span><span class="o">:</span> <span class="nx">PathToRegexpOptions</span> <span class="o">=</span>
    <span class="nx">route</span><span class="p">.</span><span class="nx">pathToRegexpOptions</span> <span class="o">||</span> <span class="p">{}</span>
   <span class="c1">// 规范化path，主要构建`${parent.path}/${path}`的path</span>
  <span class="kr">const</span> <span class="nx">normalizedPath</span> <span class="o">=</span> <span class="nx">normalizePath</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">pathToRegexpOptions</span><span class="p">.</span><span class="nx">strict</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">route</span><span class="p">.</span><span class="nx">caseSensitive</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">pathToRegexpOptions</span><span class="p">.</span><span class="nx">sensitive</span> <span class="o">=</span> <span class="nx">route</span><span class="p">.</span><span class="nx">caseSensitive</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">record</span><span class="o">:</span> <span class="nx">RouteRecord</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">path</span><span class="o">:</span> <span class="nx">normalizedPath</span><span class="p">,</span>
    <span class="c1">// 通过path-to-regexp构造一个正则</span>
    <span class="nx">regex</span><span class="o">:</span> <span class="nx">compileRouteRegex</span><span class="p">(</span><span class="nx">normalizedPath</span><span class="p">,</span> <span class="nx">pathToRegexpOptions</span><span class="p">),</span>
    <span class="nx">components</span><span class="o">:</span> <span class="nx">route</span><span class="p">.</span><span class="nx">components</span> <span class="o">||</span> <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="nx">route</span><span class="p">.</span><span class="nx">component</span> <span class="p">},</span>
    <span class="nx">alias</span><span class="o">:</span> <span class="nx">route</span><span class="p">.</span><span class="nx">alias</span>
      <span class="o">?</span> <span class="k">typeof</span> <span class="nx">route</span><span class="p">.</span><span class="nx">alias</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span>
        <span class="o">?</span> <span class="p">[</span><span class="nx">route</span><span class="p">.</span><span class="nx">alias</span><span class="p">]</span>
        <span class="o">:</span> <span class="nx">route</span><span class="p">.</span><span class="nx">alias</span>
      <span class="o">:</span> <span class="p">[],</span>
    <span class="nx">instances</span><span class="o">:</span> <span class="p">{},</span>
    <span class="nx">enteredCbs</span><span class="o">:</span> <span class="p">{},</span>
    <span class="nx">name</span><span class="p">,</span>
    <span class="nx">parent</span><span class="p">,</span>
    <span class="nx">matchAs</span><span class="p">,</span>
    <span class="nx">redirect</span><span class="o">:</span> <span class="nx">route</span><span class="p">.</span><span class="nx">redirect</span><span class="p">,</span>
    <span class="nx">beforeEnter</span><span class="o">:</span> <span class="nx">route</span><span class="p">.</span><span class="nx">beforeEnter</span><span class="p">,</span>
    <span class="nx">meta</span><span class="o">:</span> <span class="nx">route</span><span class="p">.</span><span class="nx">meta</span> <span class="o">||</span> <span class="p">{},</span>
    <span class="nx">props</span><span class="o">:</span>
      <span class="nx">route</span><span class="p">.</span><span class="nx">props</span> <span class="o">==</span> <span class="kc">null</span>
        <span class="o">?</span> <span class="p">{}</span>
        <span class="o">:</span> <span class="nx">route</span><span class="p">.</span><span class="nx">components</span>
          <span class="o">?</span> <span class="nx">route</span><span class="p">.</span><span class="nx">props</span>
          <span class="o">:</span> <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="nx">route</span><span class="p">.</span><span class="nx">props</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">route</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">childMatchAs</span> <span class="o">=</span> <span class="nx">matchAs</span>
        <span class="o">?</span> <span class="nx">cleanPath</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">matchAs</span><span class="p">}</span><span class="o">/</span><span class="nx">$</span><span class="p">{</span><span class="nx">child</span><span class="p">.</span><span class="nx">path</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
        <span class="o">:</span> <span class="kc">undefined</span>
      <span class="nx">addRouteRecord</span><span class="p">(</span><span class="nx">pathList</span><span class="p">,</span> <span class="nx">pathMap</span><span class="p">,</span> <span class="nx">nameMap</span><span class="p">,</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">childMatchAs</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pathMap</span><span class="p">[</span><span class="nx">record</span><span class="p">.</span><span class="nx">path</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">pathList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span>
    <span class="nx">pathMap</span><span class="p">[</span><span class="nx">record</span><span class="p">.</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">record</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">alias</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">aliases</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">alias</span><span class="p">)</span> <span class="o">?</span> <span class="nx">route</span><span class="p">.</span><span class="nx">alias</span> <span class="o">:</span> <span class="p">[</span><span class="nx">route</span><span class="p">.</span><span class="nx">alias</span><span class="p">]</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">aliases</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">alias</span> <span class="o">=</span> <span class="nx">aliases</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>

      <span class="kr">const</span> <span class="nx">aliasRoute</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">path</span><span class="o">:</span> <span class="nx">alias</span><span class="p">,</span>
        <span class="nx">children</span><span class="o">:</span> <span class="nx">route</span><span class="p">.</span><span class="nx">children</span>
      <span class="p">}</span>
      <span class="nx">addRouteRecord</span><span class="p">(</span>
        <span class="nx">pathList</span><span class="p">,</span>
        <span class="nx">pathMap</span><span class="p">,</span>
        <span class="nx">nameMap</span><span class="p">,</span>
        <span class="nx">aliasRoute</span><span class="p">,</span>
        <span class="nx">parent</span><span class="p">,</span>
        <span class="nx">record</span><span class="p">.</span><span class="nx">path</span> <span class="o">||</span> <span class="s1">&#39;/&#39;</span> <span class="c1">// matchAs</span>
      <span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">nameMap</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
      <span class="nx">nameMap</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">record</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>通过上面的代码，大概可以了解到pathList是整个path的完整路径的数据，pathMap是path为key，值为routeRecord的map,nameMap是key为name，值为routeRecord的map。</p>
<p>match的主要功能是通过目标路径匹配定义的routeRecord数据，根据routeRecord和location信息来_createRoute。</p>
<pre><code class="lang-js"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">_createRoute</span> <span class="p">(</span>
    <span class="nx">record</span><span class="o">:</span> <span class="o">?</span><span class="nx">RouteRecord</span><span class="p">,</span>
    <span class="nx">location</span><span class="o">:</span> <span class="nx">Location</span><span class="p">,</span>
    <span class="nx">redirectedFrom</span><span class="o">?:</span> <span class="nx">Location</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">Route</span> <span class="p">{</span>
    <span class="c1">// 如果跳转，直接跳转</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">record</span> <span class="o">&amp;&amp;</span> <span class="nx">record</span><span class="p">.</span><span class="nx">redirect</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="nx">record</span><span class="p">,</span> <span class="nx">redirectedFrom</span> <span class="o">||</span> <span class="nx">location</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// alias</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">record</span> <span class="o">&amp;&amp;</span> <span class="nx">record</span><span class="p">.</span><span class="nx">matchAs</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">alias</span><span class="p">(</span><span class="nx">record</span><span class="p">,</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">record</span><span class="p">.</span><span class="nx">matchAs</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">//普通路由</span>
    <span class="k">return</span> <span class="nx">createRoute</span><span class="p">(</span><span class="nx">record</span><span class="p">,</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">redirectedFrom</span><span class="p">,</span> <span class="nx">router</span><span class="p">)</span>
  <span class="p">}</span>
</pre></div>

</code></pre>
<p>然后，我们再回到transitionTo，得到正确的route后，接下来看看confirmTransition操作。</p>
<h3 id="confirmtransition">confirmTransition</h3>
<pre><code class="lang-js"><div class="highlight"><pre>  <span class="nx">confirmTransition</span> <span class="p">(</span><span class="nx">route</span><span class="o">:</span> <span class="nx">Route</span><span class="p">,</span> <span class="nx">onComplete</span><span class="o">:</span> <span class="nb">Function</span><span class="p">,</span> <span class="nx">onAbort</span><span class="o">?:</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pending</span> <span class="o">=</span> <span class="nx">route</span>
    <span class="kr">const</span> <span class="nx">abort</span> <span class="o">=</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// .... 通用处理处理错误代码</span>
      <span class="nx">onAbort</span> <span class="o">&amp;&amp;</span> <span class="nx">onAbort</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">lastRouteIndex</span> <span class="o">=</span> <span class="nx">route</span><span class="p">.</span><span class="nx">matched</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="kr">const</span> <span class="nx">lastCurrentIndex</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">matched</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="p">(</span>
      <span class="nx">isSameRoute</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">current</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="c1">// in the case the route map has been dynamically appended to</span>
      <span class="nx">lastRouteIndex</span> <span class="o">===</span> <span class="nx">lastCurrentIndex</span> <span class="o">&amp;&amp;</span>
      <span class="nx">route</span><span class="p">.</span><span class="nx">matched</span><span class="p">[</span><span class="nx">lastRouteIndex</span><span class="p">]</span> <span class="o">===</span> <span class="nx">current</span><span class="p">.</span><span class="nx">matched</span><span class="p">[</span><span class="nx">lastCurrentIndex</span><span class="p">]</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="c1">//相同的route，abort跳转</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">ensureURL</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">abort</span><span class="p">(</span><span class="nx">createNavigationDuplicatedError</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">route</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="p">{</span> <span class="nx">updated</span><span class="p">,</span> <span class="nx">deactivated</span><span class="p">,</span> <span class="nx">activated</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">resolveQueue</span><span class="p">(</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">matched</span><span class="p">,</span>
      <span class="nx">route</span><span class="p">.</span><span class="nx">matched</span>
    <span class="p">)</span>

    <span class="c1">//切换route的hook队列</span>
    <span class="kr">const</span> <span class="nx">queue</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;?</span><span class="nx">NavigationGuard</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span>
      <span class="c1">// in-component leave guards</span>
      <span class="nx">extractLeaveGuards</span><span class="p">(</span><span class="nx">deactivated</span><span class="p">),</span>
      <span class="c1">// global before hooks</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">beforeHooks</span><span class="p">,</span>
      <span class="c1">// in-component update hooks</span>
      <span class="nx">extractUpdateHooks</span><span class="p">(</span><span class="nx">updated</span><span class="p">),</span>
      <span class="c1">// in-config enter guards</span>
      <span class="nx">activated</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">m</span> <span class="o">=&gt;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">beforeEnter</span><span class="p">),</span>
      <span class="c1">// async components</span>
      <span class="nx">resolveAsyncComponents</span><span class="p">(</span><span class="nx">activated</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="kr">const</span> <span class="nx">iterator</span> <span class="o">=</span> <span class="p">(</span><span class="nx">hook</span><span class="o">:</span> <span class="nx">NavigationGuard</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pending</span> <span class="o">!==</span> <span class="nx">route</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 中间跳转到新的route</span>
        <span class="k">return</span> <span class="nx">abort</span><span class="p">(</span><span class="nx">createNavigationCancelledError</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">route</span><span class="p">))</span>
      <span class="p">}</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">hook</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="p">(</span><span class="nx">to</span><span class="o">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">to</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// next(false) -&gt; abort navigation, ensure current URL</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">ensureURL</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
            <span class="nx">abort</span><span class="p">(</span><span class="nx">createNavigationAbortedError</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">route</span><span class="p">))</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isError</span><span class="p">(</span><span class="nx">to</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">ensureURL</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
            <span class="nx">abort</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
            <span class="k">typeof</span> <span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span>
            <span class="p">(</span><span class="k">typeof</span> <span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span>
              <span class="p">(</span><span class="k">typeof</span> <span class="nx">to</span><span class="p">.</span><span class="nx">path</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">to</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">))</span>
          <span class="p">)</span> <span class="p">{</span>
            <span class="c1">// next(&#39;/&#39;) or next({ path: &#39;/&#39; }) -&gt; redirect</span>
            <span class="nx">abort</span><span class="p">(</span><span class="nx">createNavigationRedirectedError</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">route</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">to</span><span class="p">.</span><span class="nx">replace</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// confirm transition and pass on the value</span>
            <span class="nx">next</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">})</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">abort</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// </span>
    <span class="nx">runQueue</span><span class="p">(</span><span class="nx">queue</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// wait until async components are resolved before</span>
      <span class="c1">// extracting in-component enter guards</span>
      <span class="kr">const</span> <span class="nx">enterGuards</span> <span class="o">=</span> <span class="nx">extractEnterGuards</span><span class="p">(</span><span class="nx">activated</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">queue</span> <span class="o">=</span> <span class="nx">enterGuards</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">resolveHooks</span><span class="p">)</span>
      <span class="nx">runQueue</span><span class="p">(</span><span class="nx">queue</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pending</span> <span class="o">!==</span> <span class="nx">route</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">abort</span><span class="p">(</span><span class="nx">createNavigationCancelledError</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">route</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">pending</span> <span class="o">=</span> <span class="kc">null</span>
        <span class="nx">onComplete</span><span class="p">(</span><span class="nx">route</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">$nextTick</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">handleRouteEntered</span><span class="p">(</span><span class="nx">route</span><span class="p">)</span>
          <span class="p">})</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">}</span>
</pre></div>

</code></pre>
<p>这里是一个很关键的方法，路由跳转需要依次执行resolveQueue，extractLeaveGuards，extractUpdateHooks，resolveAsyncComponents，runQueue等关键方法，我们先来看resolveQueue。</p>
<h3 id="resolvequeue">resolveQueue</h3>
<p>resolveQueue源码：</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">resolveQueue</span> <span class="p">(</span>
  <span class="nx">current</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">next</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span>
<span class="p">)</span><span class="o">:</span> <span class="p">{</span>
  <span class="nx">updated</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">activated</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">deactivated</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span>
<span class="p">}</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">i</span>
  <span class="kr">const</span> <span class="nx">max</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">next</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">max</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">current</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">next</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">break</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">updated</span><span class="o">:</span> <span class="nx">next</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>
    <span class="nx">activated</span><span class="o">:</span> <span class="nx">next</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span>
    <span class="nx">deactivated</span><span class="o">:</span> <span class="nx">current</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>resolveQueue主要是返回哪些组价需要更新，哪些组件需要创建，哪些组件需要销毁。</p>
<h3 id="extractleaveguards-extractupdatehooks">extractLeaveGuards &amp; extractUpdateHooks</h3>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">extractLeaveGuards</span> <span class="p">(</span><span class="nx">deactivated</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;?</span><span class="nb">Function</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">extractGuards</span><span class="p">(</span><span class="nx">deactivated</span><span class="p">,</span> <span class="s1">&#39;beforeRouteLeave&#39;</span><span class="p">,</span> <span class="nx">bindGuard</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">extractUpdateHooks</span> <span class="p">(</span><span class="nx">updated</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;?</span><span class="nb">Function</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">extractGuards</span><span class="p">(</span><span class="nx">updated</span><span class="p">,</span> <span class="s1">&#39;beforeRouteUpdate&#39;</span><span class="p">,</span> <span class="nx">bindGuard</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">extractGuards</span> <span class="p">(</span>
  <span class="nx">records</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span>
  <span class="nx">bind</span><span class="o">:</span> <span class="nb">Function</span><span class="p">,</span>
  <span class="nx">reverse</span><span class="o">?:</span> <span class="kr">boolean</span>
<span class="p">)</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;?</span><span class="nb">Function</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">guards</span> <span class="o">=</span> <span class="nx">flatMapComponents</span><span class="p">(</span><span class="nx">records</span><span class="p">,</span> <span class="p">(</span><span class="nx">def</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">guard</span> <span class="o">=</span> <span class="nx">extractGuard</span><span class="p">(</span><span class="nx">def</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">guard</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">guard</span><span class="p">)</span>
        <span class="o">?</span> <span class="nx">guard</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">guard</span> <span class="o">=&gt;</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">guard</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">key</span><span class="p">))</span>
        <span class="o">:</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">guard</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="k">return</span> <span class="nx">flatten</span><span class="p">(</span><span class="nx">reverse</span> <span class="o">?</span> <span class="nx">guards</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span> <span class="o">:</span> <span class="nx">guards</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// guard通过apply将this指定为vm对象</span>
<span class="kd">function</span> <span class="nx">bindGuard</span> <span class="p">(</span><span class="nx">guard</span><span class="o">:</span> <span class="nx">NavigationGuard</span><span class="p">,</span> <span class="nx">instance</span><span class="o">:</span> <span class="o">?</span><span class="nx">_Vue</span><span class="p">)</span><span class="o">:</span> <span class="o">?</span><span class="nx">NavigationGuard</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="nx">boundRouteGuard</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">guard</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>主要是提取组件的beforeRouteLeave和beforeRouteUpdate相关的导航守卫。</p>
<h3 id="resolveasynccomponents">resolveAsyncComponents</h3>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">export</span> <span class="kd">function</span> <span class="nx">resolveAsyncComponents</span> <span class="p">(</span><span class="nx">matched</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">RouteRecord</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span> <span class="nb">Function</span> <span class="p">{</span>
  <span class="c1">// </span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">hasAsync</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="kd">let</span> <span class="nx">pending</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">let</span> <span class="nx">error</span> <span class="o">=</span> <span class="kc">null</span>

    <span class="nx">flatMapComponents</span><span class="p">(</span><span class="nx">matched</span><span class="p">,</span> <span class="p">(</span><span class="nx">def</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">def</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">def</span><span class="p">.</span><span class="nx">cid</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">hasAsync</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="nx">pending</span><span class="o">++</span>

        <span class="kr">const</span> <span class="nx">resolve</span> <span class="o">=</span> <span class="nx">once</span><span class="p">(</span><span class="nx">resolvedDef</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">isESModule</span><span class="p">(</span><span class="nx">resolvedDef</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">resolvedDef</span> <span class="o">=</span> <span class="nx">resolvedDef</span><span class="p">.</span><span class="k">default</span>
          <span class="p">}</span>
          <span class="c1">// save resolved on async factory in case it&#39;s used elsewhere</span>
          <span class="nx">def</span><span class="p">.</span><span class="nx">resolved</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">resolvedDef</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span>
            <span class="o">?</span> <span class="nx">resolvedDef</span>
            <span class="o">:</span> <span class="nx">_Vue</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">resolvedDef</span><span class="p">)</span>
          <span class="nx">match</span><span class="p">.</span><span class="nx">components</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">resolvedDef</span>
          <span class="nx">pending</span><span class="o">--</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">pending</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">next</span><span class="p">()</span>
          <span class="p">}</span>
        <span class="p">})</span>

        <span class="kr">const</span> <span class="nx">reject</span> <span class="o">=</span> <span class="nx">once</span><span class="p">(</span><span class="nx">reason</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="kr">const</span> <span class="nx">msg</span> <span class="o">=</span> <span class="err">`</span><span class="nx">Failed</span> <span class="nx">to</span> <span class="nx">resolve</span> <span class="nx">async</span> <span class="nx">component</span> <span class="nx">$</span><span class="p">{</span><span class="nx">key</span><span class="p">}</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">reason</span><span class="p">}</span><span class="err">`</span>
          <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s1">&#39;production&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">warn</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">error</span> <span class="o">=</span> <span class="nx">isError</span><span class="p">(</span><span class="nx">reason</span><span class="p">)</span>
              <span class="o">?</span> <span class="nx">reason</span>
              <span class="o">:</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
            <span class="nx">next</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">})</span>

        <span class="kd">let</span> <span class="nx">res</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nx">res</span> <span class="o">=</span> <span class="nx">def</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">reject</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">res</span><span class="p">.</span><span class="nx">then</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// new syntax in Vue 2.3</span>
            <span class="kr">const</span> <span class="nx">comp</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">component</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">comp</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">comp</span><span class="p">.</span><span class="nx">then</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">comp</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">})</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasAsync</span><span class="p">)</span> <span class="nx">next</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>主要用来处理异步组建的问题，通过判断路由上定义的组件是否是异步组件，然后在得到真正的异步组件之前将其路由挂起。</p>
<h3 id="runqueue">runQueue</h3>
<p>runQueue主要是执行异步函数队列。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">export</span> <span class="kd">function</span> <span class="nx">runQueue</span> <span class="p">(</span><span class="nx">queue</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;?</span><span class="nx">NavigationGuard</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">fn</span><span class="o">:</span> <span class="nb">Function</span><span class="p">,</span> <span class="nx">cb</span><span class="o">:</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">step</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">//全部执行完，执行回调</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&gt;=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cb</span><span class="p">()</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">//如果队列有值</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">queue</span><span class="p">[</span><span class="nx">index</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">//fn 是 iterator函数</span>
        <span class="nx">fn</span><span class="p">(</span><span class="nx">queue</span><span class="p">[</span><span class="nx">index</span><span class="p">],</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">step</span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">})</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">step</span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">step</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>在confirmTransition中通过下面的方式来调度队列的执行：</p>
<pre><code class="lang-js"><div class="highlight"><pre> <span class="nx">runQueue</span><span class="p">(</span><span class="nx">queue</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="p">})</span>
</pre></div>

</code></pre>
<p>fn传递为iterator函数。iterator函数的执行：</p>
<pre><code class="lang-js"><div class="highlight"><pre>    <span class="kr">const</span> <span class="nx">iterator</span> <span class="o">=</span> <span class="p">(</span><span class="nx">hook</span><span class="o">:</span> <span class="nx">NavigationGuard</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
     <span class="c1">// 即将跳转的不是route，导航取消错误</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pending</span> <span class="o">!==</span> <span class="nx">route</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">abort</span><span class="p">(</span><span class="nx">createNavigationCancelledError</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">route</span><span class="p">))</span>
      <span class="p">}</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// 导航守卫</span>
        <span class="nx">hook</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="p">(</span><span class="nx">to</span><span class="o">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="c1">// 导航守卫 调用next(false)，中断当前的导航</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">to</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// next(false) -&gt; abort navigation, ensure current URL</span>
            <span class="c1">// 重置到from路由对应的URL地址</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">ensureURL</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
            <span class="nx">abort</span><span class="p">(</span><span class="nx">createNavigationAbortedError</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">route</span><span class="p">))</span>
           <span class="c1">// 导航守卫 调用next(new Error(`msg`))</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isError</span><span class="p">(</span><span class="nx">to</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">ensureURL</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
            <span class="nx">abort</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
            <span class="k">typeof</span> <span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span>
            <span class="p">(</span><span class="k">typeof</span> <span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span>
              <span class="p">(</span><span class="k">typeof</span> <span class="nx">to</span><span class="p">.</span><span class="nx">path</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">to</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">))</span>
          <span class="p">)</span> <span class="p">{</span>
            <span class="c1">// next(&#39;/&#39;) or next({ path: &#39;/&#39; }) -&gt; redirect</span>
            <span class="c1">// 跳转到其它路由</span>
            <span class="nx">abort</span><span class="p">(</span><span class="nx">createNavigationRedirectedError</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">route</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">to</span><span class="p">.</span><span class="nx">replace</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// confirm transition and pass on the value</span>
            <span class="c1">// 一般情况下没有参数 next()，当前钩子处理完成，交给下一个钩子</span>
            <span class="nx">next</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">})</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//执行错误，直接取消导航</span>
        <span class="nx">abort</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
</pre></div>

</code></pre>
<p>整理一下现在的流程：</p>
<p>1、执行transitionTo函数，先得到需要跳转路由的匹配的route。</p>
<p>2、执行confirmTransition函数。</p>
<p>3、confirmTransition函数内部判断是否需要跳转，如果不需要，则直接中断返回。</p>
<p>4、confirmTransition判断如果需要跳转，则先得到钩子函数的任务队列queue。</p>
<p>5、通过runQueue函数来批次导航守卫们。</p>
<p>6、一直到整个队列执行完毕后，开始处理完成后的回调函数。</p>
<h3 id="-">导航完成后回调</h3>
<pre><code class="lang-js"><div class="highlight"><pre>    <span class="nx">runQueue</span><span class="p">(</span><span class="nx">queue</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// beforeRouteEnter钩子函数</span>
      <span class="kr">const</span> <span class="nx">enterGuards</span> <span class="o">=</span> <span class="nx">extractEnterGuards</span><span class="p">(</span><span class="nx">activated</span><span class="p">)</span>
      <span class="c1">// 获取beforeResolve钩子函数，并生成一个新的queue</span>
      <span class="kr">const</span> <span class="nx">queue</span> <span class="o">=</span> <span class="nx">enterGuards</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">resolveHooks</span><span class="p">)</span>
      <span class="nx">runQueue</span><span class="p">(</span><span class="nx">queue</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pending</span> <span class="o">!==</span> <span class="nx">route</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">abort</span><span class="p">(</span><span class="nx">createNavigationCancelledError</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">route</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="c1">// 情况pending</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">pending</span> <span class="o">=</span> <span class="kc">null</span>
        <span class="c1">// 调用onComplete函数</span>
        <span class="nx">onComplete</span><span class="p">(</span><span class="nx">route</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">$nextTick</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="c1">// postEnterCbs所有回调</span>
            <span class="nx">handleRouteEntered</span><span class="p">(</span><span class="nx">route</span><span class="p">)</span>
          <span class="p">})</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">})</span>
</pre></div>

</code></pre>
<p>主要是执行一些路由进入的导航守卫。</p>
<h3 id="confirmtransition-oncomplete-">confirmTransition的onComplete参数</h3>
<pre><code class="lang-js"><div class="highlight"><pre>    <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">updateRoute</span><span class="p">(</span><span class="nx">route</span><span class="p">)</span>
    <span class="nx">onComplete</span> <span class="o">&amp;&amp;</span> <span class="nx">onComplete</span><span class="p">(</span><span class="nx">route</span><span class="p">)</span>
    <span class="c1">// 确保url更新</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ensureURL</span><span class="p">()</span>
    <span class="c1">// 执行router的afterHooks</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">afterHooks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">hook</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">hook</span> <span class="o">&amp;&amp;</span> <span class="nx">hook</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">prev</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="c1">// fire ready cbs once</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ready</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="c1">// 首次完成，执行readCbs</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">readyCbs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">cb</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">cb</span><span class="p">(</span><span class="nx">route</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span>
 <span class="p">}</span>
<span class="c1">// updateRoute</span>
  <span class="nx">updateRoute</span> <span class="p">(</span><span class="nx">route</span><span class="o">:</span> <span class="nx">Route</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">route</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">cb</span><span class="p">(</span><span class="nx">route</span><span class="p">)</span>
  <span class="p">}</span>
</pre></div>

</code></pre>
<p>至此，已经完成了route的更新，在install函数中设置了对route的数据劫持，变更route会通知相应的观察者。</p>
<p>路由变更完成后，会执行onComplete，这个就是前面的setupHashListener。</p>
<h3 id="setuphashlistener">setupHashListener</h3>
<pre><code class="lang-js"><div class="highlight"><pre>    <span class="kr">const</span> <span class="nx">setupListeners</span> <span class="o">=</span> <span class="nx">routeOrError</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">history</span><span class="p">.</span><span class="nx">setupListeners</span><span class="p">()</span>
      <span class="nx">handleInitialScroll</span><span class="p">(</span><span class="nx">routeOrError</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">history</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span>
    <span class="nx">history</span><span class="p">.</span><span class="nx">getCurrentLocation</span><span class="p">(),</span>
    <span class="nx">setupListeners</span><span class="p">,</span>
    <span class="nx">setupListeners</span>
    <span class="p">)</span>

  <span class="nx">setupListeners</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">listeners</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">router</span>
    <span class="c1">//处理滚动</span>
    <span class="kr">const</span> <span class="nx">expectScroll</span> <span class="o">=</span> <span class="nx">router</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">scrollBehavior</span>
    <span class="kr">const</span> <span class="nx">supportsScroll</span> <span class="o">=</span> <span class="nx">supportsPushState</span> <span class="o">&amp;&amp;</span> <span class="nx">expectScroll</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">supportsScroll</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">listeners</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">setupScroll</span><span class="p">())</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">handleRoutingEvent</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ensureSlash</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="nx">getHash</span><span class="p">(),</span> <span class="nx">route</span> <span class="o">=&gt;</span> <span class="p">{</span>
         <span class="c1">//处理滚动</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">supportsScroll</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">handleScroll</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">supportsPushState</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">replaceHash</span><span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">eventType</span> <span class="o">=</span> <span class="nx">supportsPushState</span> <span class="o">?</span> <span class="s1">&#39;popstate&#39;</span> <span class="o">:</span> <span class="s1">&#39;hashchange&#39;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span>
      <span class="nx">eventType</span><span class="p">,</span>
      <span class="nx">handleRoutingEvent</span>
    <span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">listeners</span><span class="p">.</span><span class="nx">push</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">eventType</span><span class="p">,</span> <span class="nx">handleRoutingEvent</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>
</pre></div>

</code></pre>
<p>可以看到setupListeners主要做了2件事情，一个是对路由切换滚动位置的处理。另一个是对路由变动做了一次监听window.addEventlistener(supportsPushState ? &#39;popstate&#39; : &#39;hashchange&#39;,() =&gt; {})。</p>
<h2 id="vuerouter-html5history">VueRouter之HTML5History</h2>
<p>基本上代码运行流程跟HashHistory一致，暂不细聊。</p>
<h2 id="vuerouter-api">VueRouter之API</h2>
<p>push，replace，go，back，forward之类的API。</p>
<pre><code class="lang-js"><div class="highlight"><pre>  <span class="nx">push</span> <span class="p">(</span><span class="nx">location</span><span class="o">:</span> <span class="nx">RawLocation</span><span class="p">,</span> <span class="nx">onComplete</span><span class="o">?:</span> <span class="nb">Function</span><span class="p">,</span> <span class="nx">onAbort</span><span class="o">?:</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// $flow-disable-line</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">onComplete</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">onAbort</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">Promise</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
      <span class="p">})</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="nx">onComplete</span><span class="p">,</span> <span class="nx">onAbort</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">replace</span> <span class="p">(</span><span class="nx">location</span><span class="o">:</span> <span class="nx">RawLocation</span><span class="p">,</span> <span class="nx">onComplete</span><span class="o">?:</span> <span class="nb">Function</span><span class="p">,</span> <span class="nx">onAbort</span><span class="o">?:</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// $flow-disable-line</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">onComplete</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">onAbort</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">Promise</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span>
      <span class="p">})</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="nx">onComplete</span><span class="p">,</span> <span class="nx">onAbort</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">go</span> <span class="p">(</span><span class="nx">n</span><span class="o">:</span> <span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">back</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">forward</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">}</span>
</pre></div>

</code></pre>
<p>push和replace，首先判断了传没成功回调和失败回调，没传转化为Promise。然后调用history的push和replace方法。</p>
<p>go，back，forward主要是调用history.go方法，不再过度解读。</p>
<h3 id="push-replace">push &amp; replace</h3>
<pre><code class="lang-js"><div class="highlight"><pre>  <span class="nx">push</span> <span class="p">(</span><span class="nx">location</span><span class="o">:</span> <span class="nx">RawLocation</span><span class="p">,</span> <span class="nx">onComplete</span><span class="o">?:</span> <span class="nb">Function</span><span class="p">,</span> <span class="nx">onAbort</span><span class="o">?:</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">current</span><span class="o">:</span> <span class="nx">fromRoute</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span>
      <span class="nx">location</span><span class="p">,</span>
      <span class="nx">route</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">pushHash</span><span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">)</span>
        <span class="nx">handleScroll</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">fromRoute</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
        <span class="nx">onComplete</span> <span class="o">&amp;&amp;</span> <span class="nx">onComplete</span><span class="p">(</span><span class="nx">route</span><span class="p">)</span>
      <span class="p">},</span>
      <span class="nx">onAbort</span>
    <span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">//</span>
  <span class="nx">replace</span> <span class="p">(</span><span class="nx">location</span><span class="o">:</span> <span class="nx">RawLocation</span><span class="p">,</span> <span class="nx">onComplete</span><span class="o">?:</span> <span class="nb">Function</span><span class="p">,</span> <span class="nx">onAbort</span><span class="o">?:</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">current</span><span class="o">:</span> <span class="nx">fromRoute</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span>
      <span class="nx">location</span><span class="p">,</span>
      <span class="nx">route</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">replaceHash</span><span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">)</span>
        <span class="nx">handleScroll</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">fromRoute</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
        <span class="nx">onComplete</span> <span class="o">&amp;&amp;</span> <span class="nx">onComplete</span><span class="p">(</span><span class="nx">route</span><span class="p">)</span>
      <span class="p">},</span>
      <span class="nx">onAbort</span>
    <span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">pushHash</span> <span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">supportsPushState</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">pushState</span><span class="p">(</span><span class="nx">getUrl</span><span class="p">(</span><span class="nx">path</span><span class="p">))</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="nx">path</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">replaceHash</span> <span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">supportsPushState</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">replaceState</span><span class="p">(</span><span class="nx">getUrl</span><span class="p">(</span><span class="nx">path</span><span class="p">))</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">getUrl</span><span class="p">(</span><span class="nx">path</span><span class="p">))</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>

</code></pre>
<p>push和replace直接调用transitionTo，参数为用户传递的location对象。</p>
<h2 id="vuerouter-">VueRouter之路由变更监听</h2>
<h3 id="-">浏览器的跳转动作</h3>
<p>hash的情况：</p>
<pre><code class="lang-js"><div class="highlight"><pre>  <span class="kr">const</span> <span class="nx">handleRoutingEvent</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ensureSlash</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="nx">getHash</span><span class="p">(),</span> <span class="nx">route</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">supportsScroll</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">handleScroll</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">supportsPushState</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">replaceHash</span><span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">}</span>
  <span class="c1">//</span>
  <span class="kr">const</span> <span class="nx">eventType</span> <span class="o">=</span> <span class="nx">supportsPushState</span> <span class="o">?</span> <span class="s1">&#39;popstate&#39;</span> <span class="o">:</span> <span class="s1">&#39;hashchange&#39;</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span>
    <span class="nx">eventType</span><span class="p">,</span>
    <span class="nx">handleRoutingEvent</span>
  <span class="p">)</span>
</pre></div>

</code></pre>
<p>主要是监控popstate和hashchange事件，然后调用transitionTo进行跳转。</p>
<p>history模式的也类似于，只不过history模式下一定支持popstate，所以只监听popstate事件。</p>
<h2 id="vuerouter-routerview">VueRouter之RouterView</h2>
<p>首先看一下源码：</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;RouterView&#39;</span><span class="p">,</span>
  <span class="c1">//无状态组件和无实例，使用一个简单的render函数返回虚拟节点使它们渲染的代价更小</span>
  <span class="nx">functional</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="c1">//props只有一个name</span>
  <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
      <span class="k">default</span><span class="o">:</span> <span class="s1">&#39;default&#39;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">render</span> <span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">props</span><span class="p">,</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">data</span> <span class="p">})</span> <span class="p">{</span>

    <span class="nx">data</span><span class="p">.</span><span class="nx">routerView</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="kr">const</span> <span class="nx">h</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">$createElement</span>
    <span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">name</span>
    <span class="kr">const</span> <span class="nx">route</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">$route</span>
    <span class="kr">const</span> <span class="nx">cache</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">_routerViewCache</span> <span class="o">||</span> <span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">_routerViewCache</span> <span class="o">=</span> <span class="p">{})</span>

    <span class="kd">let</span> <span class="nx">depth</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="p">(</span><span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">_routerRoot</span> <span class="o">!==</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">vnodeData</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">$vnode</span> <span class="o">?</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">$vnode</span><span class="p">.</span><span class="nx">data</span> <span class="o">:</span> <span class="p">{}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">vnodeData</span><span class="p">.</span><span class="nx">routerView</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">depth</span><span class="o">++</span>
      <span class="p">}</span>
      <span class="nx">parent</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">$parent</span>
    <span class="p">}</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">routerViewDepth</span> <span class="o">=</span> <span class="nx">depth</span>
    <span class="c1">//routerViewDepth，当前routerView的层数</span>

    <span class="c1">//根据层级找到相关的组件配置</span>
    <span class="kr">const</span> <span class="nx">matched</span> <span class="o">=</span> <span class="nx">route</span><span class="p">.</span><span class="nx">matched</span><span class="p">[</span><span class="nx">depth</span><span class="p">]</span>
    <span class="kr">const</span> <span class="nx">component</span> <span class="o">=</span> <span class="nx">matched</span> <span class="o">&amp;&amp;</span> <span class="nx">matched</span><span class="p">.</span><span class="nx">components</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>

    <span class="c1">// render empty node if no matched route or no config component</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">matched</span> <span class="o">||</span> <span class="o">!</span><span class="nx">component</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>
      <span class="k">return</span> <span class="nx">h</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// cache component</span>
    <span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">component</span> <span class="p">}</span>

    <span class="c1">// attach instance registration hook</span>
    <span class="c1">// this will be called in the instance&#39;s injected lifecycle hooks</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">registerRouteInstance</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vm</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// install时调用时是 this this，也就是vm，vm</span>
      <span class="c1">// destory时只传递了this，val为undefined</span>
      <span class="kr">const</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">.</span><span class="nx">instances</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
      <span class="k">if</span> <span class="p">(</span>
        <span class="c1">// 初始化时，且不等于current</span>
        <span class="p">(</span><span class="nx">val</span> <span class="o">&amp;&amp;</span> <span class="nx">current</span> <span class="o">!==</span> <span class="nx">vm</span><span class="p">)</span> <span class="o">||</span>
        <span class="c1">// 注销时，等于current</span>
        <span class="p">(</span><span class="o">!</span><span class="nx">val</span> <span class="o">&amp;&amp;</span> <span class="nx">current</span> <span class="o">===</span> <span class="nx">vm</span><span class="p">)</span>
      <span class="p">)</span> <span class="p">{</span>
        <span class="nx">matched</span><span class="p">.</span><span class="nx">instances</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kr">const</span> <span class="nx">configProps</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">.</span><span class="nx">props</span> <span class="o">&amp;&amp;</span> <span class="nx">matched</span><span class="p">.</span><span class="nx">props</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
    <span class="c1">// save route and configProps in cache</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">configProps</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">extend</span><span class="p">(</span><span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">],</span> <span class="p">{</span>
        <span class="nx">route</span><span class="p">,</span>
        <span class="nx">configProps</span>
      <span class="p">})</span>
      <span class="c1">// 路由里面的配置转换为attrs</span>
      <span class="nx">fillPropsinData</span><span class="p">(</span><span class="nx">component</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">configProps</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">h</span><span class="p">(</span><span class="nx">component</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">children</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h2 id="vuerouter-">VueRouter原理口述</h2>
<p>一般大型单页应用都会采用前端路由系统，通过改变URL，在不重新请求页面的情况下，更新页面内部分区域的视图。</p>
<p>目前主要采用两种方式：1、hash模式，URL中#号后面的部分，改变会触发hashchange事件；2、另外一种是history模式，通过pushstate和replaceState来改变url，通过popstate事件来监听url变化。</p>
<p>VueRouter是Vue的路由插件，我大概讲一下它的原理。</p>
<p>在使用之前，需要先用Vue.use安装VueRouter插件，在安装的过程中，VueRouter会mixin，beforeCreate生命周期函数，在beforeCreate中会定义一些router相关属性到vm上，然后将_route定义为响应式的，同时判断如果父级组件是RouterView，会调用RouterView组件的方法来注册当前组件实例。后面是Vue.prototype上定义$router和$route。最后是注册全局的RouterVie和RouteLink组件。</p>
<p>在实例化VueRouter对象时，需要传递包含routes数组的选项，VueRouter会把这些定义的routes打平来构建pathList,pathMap和nameMap等对象以方便后期匹配查找。route的path会用path-to-regexp库转换为正则来匹配route的params。然后根据当前URL做初次导航，导航成功后。监听URL变化事件，URL变化时获取当前URL，然后去上文根据routes构造的数据结构中找到当前的route。</p>
<p>找到route后，会依次执行导航守卫函数，导航守卫函数全部通过后，导航到新的route，因为route已经定义为响应式的，所以会触发RouterView的重新渲染，RoterView会渲染route对应的组件。</p>
<h2 id="-">参考文档</h2>
<p><a href="https://zhuanlan.zhihu.com/p/37730038">https://zhuanlan.zhihu.com/p/37730038</a></p>
</body>
</html>
