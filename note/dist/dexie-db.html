<!DOCTYPE html>
<html>
<head>
  <title>Dexie学习</title>
  <link rel="stylesheet" href="/note/note.css?ts=1640535102164">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"><link rel="shortcut icon" href="/ico.png"></head>
<body><script>var _hmt = _hmt || [];
(function () {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?256376ad73e3e50091706bb3c032e74c";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>
<h1 id="dexie-">Dexie学习</h1>
<p>dexie是IndexedDB的包装类库。Dexie主要解决原生IndexedDB存在的三个主要问题：</p>
<p>1、不明确的错误处理；2、弱查询能力；3、代码繁杂。</p>
<p>Dexie提供了一个整洁的数据库，具有深思熟虑的API设计，强大的错误处理，可扩展性，更改跟踪感知，同时扩展KeyRange的支持。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// ES7的写法</span>
<span class="kr">import</span> <span class="nx">Dexie</span> <span class="nx">from</span> <span class="s1">&#39;dexie&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">type</span> <span class="p">{</span> <span class="nx">Table</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;dexie&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dexie</span><span class="p">(</span><span class="s1">&#39;FriendDataBase&#39;</span><span class="p">);</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
  <span class="nx">friends</span><span class="o">:</span> <span class="s2">&quot;++id,name,age&quot;</span>
<span class="p">});</span>
<span class="c1">//@ts-ignore</span>
<span class="kr">const</span> <span class="nx">friendsTable</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span> <span class="nx">as</span> <span class="nx">Table</span><span class="p">;</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="s1">&#39;rw&#39;</span><span class="p">,</span> <span class="nx">friendsTable</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">joseCount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">friendsTable</span><span class="p">.</span><span class="nx">where</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Jose&#39;</span> <span class="p">}).</span><span class="nx">count</span><span class="p">();</span>
  <span class="kd">let</span> <span class="nx">hasJose</span> <span class="o">=</span> <span class="nx">joseCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasJose</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">friendsTable</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Jose&#39;</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">21</span> <span class="p">});</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Added</span> <span class="nx">friend</span> <span class="kd">with</span> <span class="nx">id</span> <span class="nx">$</span><span class="p">{</span><span class="nx">id</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">youngFriends</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">friendsTable</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">).</span><span class="nx">below</span><span class="p">(</span><span class="mi">25</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">My</span> <span class="nx">young</span> <span class="nx">friends</span><span class="err">：`</span><span class="p">,</span> <span class="nx">youngFriends</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Class的写法</span>
<span class="kr">import</span> <span class="nx">Dexie</span><span class="p">,</span> <span class="p">{</span> <span class="nx">Table</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;dexie&#39;</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">Friend</span> <span class="p">{</span>
  <span class="nx">id</span><span class="o">?:</span> <span class="nx">number</span><span class="p">;</span>
  <span class="nx">name</span><span class="o">?:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">age</span><span class="o">?:</span> <span class="nx">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">FriendDataBase</span> <span class="kr">extends</span> <span class="nx">Dexie</span> <span class="p">{</span>
  <span class="kr">public</span> <span class="nx">friends</span><span class="o">:</span> <span class="nx">Dexie</span><span class="p">.</span><span class="nx">Table</span><span class="o">&lt;</span><span class="nx">Friend</span><span class="p">,</span> <span class="nx">number</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="kr">public</span> <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="s1">&#39;FriendDataBase&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
      <span class="nx">friends</span><span class="o">:</span> <span class="s1">&#39;++id,name,age&#39;</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">friends</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;friends&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FriendDataBase</span><span class="p">();</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="s1">&#39;rw&#39;</span><span class="p">,</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">((</span><span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">where</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Josephine&#39;</span> <span class="p">}).</span><span class="nx">count</span><span class="p">())</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Josephine&quot;</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">21</span> <span class="p">});</span>
    <span class="nx">alert</span><span class="p">(</span><span class="err">`</span><span class="nx">Addded</span> <span class="nx">friend</span> <span class="kd">with</span> <span class="nx">id</span> <span class="nx">$</span><span class="p">{</span><span class="nx">id</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kr">const</span> <span class="nx">youngFriends</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">).</span><span class="nx">below</span><span class="p">(</span><span class="mi">25</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">My</span> <span class="nx">young</span> <span class="nx">friends</span><span class="err">：`</span><span class="p">,</span> <span class="nx">youngFriends</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">})</span>
</pre></div>

</code></pre>
<h2 id="dexie-doc">Dexie Doc</h2>
<p>Dexie V3.2及以后的版本，原生是支持响应式的。在V3.2版本中，我们引入了实时查询的功能。如果数据库里数据改变了，一个二叉范围树算法会高效地计算出这些改变会影响到的查询。</p>
<p>如果影响到了查询，会执行用户指定的回调，用户可以在指定的回调中重新渲染组件。</p>
<h3 id="-dexie">安装Dexie</h3>
<pre><code class="lang-bash"><div class="highlight"><pre>npm i dexie 
</pre></div>

</code></pre>
<h3 id="-db">创建db</h3>
<p>应用一般只有会一个Dexie实例，这也是你声明你需要的表及其索引的地方。Dexie实例是单例的，一般不需要懒创建它。在db的模块中导出db实例，以供其它模块使用。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">import</span> <span class="nx">Dexie</span> <span class="nx">from</span> <span class="s1">&#39;dexie&#39;</span><span class="p">;</span>

<span class="kr">export</span> <span class="kr">interface</span> <span class="nx">Friend</span> <span class="p">{</span>
  <span class="nx">id</span><span class="o">?:</span> <span class="nx">number</span><span class="p">;</span>
  <span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">age</span><span class="o">:</span> <span class="nx">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kr">class</span> <span class="nx">MyDexie</span> <span class="kr">extends</span> <span class="nx">Dexie</span> <span class="p">{</span>
  <span class="nx">friends</span><span class="o">:</span> <span class="nx">Dexie</span><span class="p">.</span><span class="nx">Table</span><span class="o">&lt;</span><span class="nx">Friend</span><span class="p">,</span> <span class="nx">number</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="s1">&#39;MyDataBae&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
      <span class="nx">friends</span><span class="o">:</span> <span class="s1">&#39;++id,name,age&#39;</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">friends</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;friends&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyDexie</span><span class="p">();</span>
</pre></div>

</code></pre>
<h3 id="-">添加数据</h3>
<p>添加数据到DB可以调用Table.add，Table.put，Table.update和Collection.mofify。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">btnAdd</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#btnAdd&#39;</span><span class="p">);</span>
  <span class="nx">btnAdd</span><span class="o">?</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">txtName</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#txtName&#39;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">HTMLInputElement</span><span class="p">;</span>
      <span class="kr">const</span> <span class="nx">txtAge</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#txtAge&#39;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">HTMLInputElement</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">txtName</span><span class="o">?</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="o">!</span><span class="nx">txtAge</span><span class="o">?</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="err">`请输入姓名和年龄！`</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">//@ts-ignore</span>
      <span class="kd">let</span> <span class="nx">db</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">myDB</span><span class="p">;</span>
      <span class="kr">const</span> <span class="nx">addId</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">txtName</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="nb">Number</span><span class="p">.</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">txtAge</span><span class="o">?</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">New</span> <span class="nx">Friend</span> <span class="nx">Id</span> <span class="nx">is</span> <span class="nx">$</span><span class="p">{</span><span class="nx">addId</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">})</span>

<span class="p">})</span>
</pre></div>

</code></pre>
<h3 id="-">查询数据</h3>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">queryAllFriends</span><span class="p">()</span> <span class="p">{</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">myDB</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span> <span class="p">})</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h3 id="-">带参数查询数据</h3>
<p>where指定字段，然后指定条件。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">async</span> <span class="kd">function</span> <span class="nx">queryWithAgeParams</span><span class="p">(</span><span class="nx">minAge</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">maxAge</span><span class="o">:</span> <span class="nx">number</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">friends</span> <span class="o">=</span> <span class="nx">await</span> <span class="nb">window</span><span class="p">.</span><span class="nx">myDB</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">).</span><span class="nx">between</span><span class="p">(</span><span class="nx">minAge</span><span class="p">,</span> <span class="nx">maxAge</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">friends</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h2 id="quick-reference">Quick Reference</h2>
<h3 id="-">声明数据库</h3>
<p>注意：不像SQL中那样，不用声明每一个字段值和类型。你只需要声明你想要添加索引的字段。</p>
<p>++代表，自动增加的key。&amp;表示Unique，*表示MultiEntey索引，[A+B]表示混合索引。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">import</span> <span class="nx">Dexie</span> <span class="nx">from</span> <span class="s1">&#39;dexie&#39;</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">Friend</span> <span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">age</span><span class="o">:</span> <span class="nx">number</span><span class="p">;</span>
  <span class="nx">id</span><span class="o">?:</span> <span class="nx">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">MyDexieDb</span> <span class="kr">extends</span> <span class="nx">Dexie</span> <span class="p">{</span>
  <span class="nx">friends</span><span class="o">:</span> <span class="nx">Dexie</span><span class="p">.</span><span class="nx">Table</span><span class="o">&lt;</span><span class="nx">Friend</span><span class="p">,</span> <span class="nx">number</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">gameSessions</span><span class="o">:</span> <span class="nx">Dexie</span><span class="p">.</span><span class="nx">Table</span><span class="o">&lt;</span><span class="nx">number</span><span class="p">,</span> <span class="nx">number</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="s1">&#39;MyDataBase&#39;</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
      <span class="nx">friends</span><span class="o">:</span> <span class="s1">&#39;++id,name,age,*tags&#39;</span><span class="p">,</span>
      <span class="nx">gameSessions</span><span class="o">:</span> <span class="s1">&#39;id,score&#39;</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">friends</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;friends&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gameSessions</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;gameSessions&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h4 id="multientry-">MultiEntry索引</h4>
<p>MultiEntry的索引表示的是索引属性的值是数组值。每一个数组中的值会指向那条记录。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">class</span> <span class="nx">MyBookDb</span> <span class="kr">extends</span> <span class="nx">Dexie</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="s1">&#39;BookDB&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
      <span class="nx">books</span><span class="o">:</span> <span class="s1">&#39;id,author,name,*categories&#39;</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">books</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;books&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">addBook</span><span class="p">(</span><span class="nx">bookItem</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">bookItem</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">queryBookByCategory</span><span class="p">(</span><span class="nx">category</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;categories&#39;</span><span class="p">).</span><span class="nx">equals</span><span class="p">(</span><span class="nx">category</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyBookDb</span><span class="p">();</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">addBook</span><span class="p">({</span>
  <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Under the Demo&quot;</span><span class="p">,</span>
  <span class="nx">author</span><span class="o">:</span> <span class="s2">&quot;Stephen King&quot;</span><span class="p">,</span>
  <span class="nx">categories</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;sci-fi&#39;</span><span class="p">,</span> <span class="s1">&#39;thriller&#39;</span><span class="p">]</span>
<span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">queryBookByCategory</span><span class="p">(</span><span class="s1">&#39;sci-fi&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">queryBookByCategory</span><span class="err">`</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<p>当使用MultiEntry索引查询时，有一定的概率会得到多条相同的记录。这种情况下需要使用Collection.distinct来去除重复记录。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">//</span>
<span class="nx">queryBooksByMultiCategory</span><span class="p">(</span><span class="nx">categoryArr</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;categories&#39;</span><span class="p">).</span><span class="nx">anyOf</span><span class="p">(...</span><span class="nx">categoryArr</span><span class="p">).</span><span class="nx">distinct</span><span class="p">().</span><span class="nx">toArray</span><span class="p">();</span>
<span class="p">}</span>
<span class="c1">//</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">queryBooksByMultiCategory</span><span class="p">([</span><span class="s1">&#39;sci-fi&#39;</span><span class="p">,</span> <span class="s1">&#39;thriller&#39;</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">queryBooksByMultiCategory</span><span class="err">`</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">})</span>
</pre></div>

</code></pre>
<h4 id="-">联合索引</h4>
<p>一个联合索引基于若干个keyPaths。它可以高效率地索引多个属性值。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">interface</span> <span class="nx">Person</span> <span class="p">{</span>
  <span class="nx">id</span><span class="o">:</span> <span class="nx">number</span><span class="p">;</span>
  <span class="nx">firstName</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">lastName</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">MyPeopleDb</span> <span class="kr">extends</span> <span class="nx">Dexie</span> <span class="p">{</span>
  <span class="nx">persons</span><span class="o">:</span> <span class="nx">Dexie</span><span class="p">.</span><span class="nx">Table</span><span class="o">&lt;</span><span class="nx">Person</span><span class="p">,</span> <span class="nx">number</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="s1">&#39;PeopleDB&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
      <span class="nx">persons</span><span class="o">:</span> <span class="s1">&#39;id,[firstName+lastName]&#39;</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">persons</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;persons&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">addPerson</span><span class="p">(</span><span class="nx">personItem</span><span class="o">:</span> <span class="nx">Person</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">persons</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">personItem</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">queryPersonByName</span><span class="p">(</span><span class="nx">nameArr</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">persons</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;[firstName+lastName]&#39;</span><span class="p">).</span><span class="nx">equals</span><span class="p">(</span><span class="nx">nameArr</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPeopleDb</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">addPerson</span><span class="p">({</span>
  <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">firstName</span><span class="o">:</span> <span class="s2">&quot;White&quot;</span><span class="p">,</span>
  <span class="nx">lastName</span><span class="o">:</span> <span class="s2">&quot;King&quot;</span><span class="p">,</span>
<span class="p">});</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">addPerson</span><span class="p">({</span>
  <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nx">firstName</span><span class="o">:</span> <span class="s2">&quot;White&quot;</span><span class="p">,</span>
  <span class="nx">lastName</span><span class="o">:</span> <span class="s2">&quot;Queen&quot;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>

</code></pre>
<p>也可以使用db.persons.where({firstName:&#39;fName&#39;,lastName:&#39;lName&#39;})来搜索。</p>
<p>#### </p>
<h2 id="-">参考文档</h2>
<p><a href="https://dexie.org/docs/Tutorial/React">https://dexie.org/docs/Tutorial/React</a></p>
<p><a href="https://dexie.org/docs/API-Reference#quick-reference">https://dexie.org/docs/API-Reference#quick-reference</a></p>
</body>
</html>
