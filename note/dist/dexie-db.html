<!DOCTYPE html>
<html>
<head>
  <title>DexieDB学习</title>
  <link rel="stylesheet" href="/note/note.css?ts=1641399846617">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"><link rel="shortcut icon" href="/ico.png"></head>
<body><script>var _hmt = _hmt || [];
(function () {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?256376ad73e3e50091706bb3c032e74c";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>
<h1 id="dexiedb-">DexieDB学习</h1>
<p>dexie是IndexedDB的包装类库。Dexie主要解决原生IndexedDB存在的三个主要问题：</p>
<p>1、不明确的错误处理；2、弱查询能力；3、代码繁杂。</p>
<p>Dexie提供了一个整洁的数据库，具有深思熟虑的API设计，强大的错误处理，可扩展性，更改跟踪感知，同时扩展KeyRange的支持。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// ES7的写法</span>
<span class="kr">import</span> <span class="nx">Dexie</span> <span class="nx">from</span> <span class="s1">&#39;dexie&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">type</span> <span class="p">{</span> <span class="nx">Table</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;dexie&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dexie</span><span class="p">(</span><span class="s1">&#39;FriendDataBase&#39;</span><span class="p">);</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
  <span class="nx">friends</span><span class="o">:</span> <span class="s2">&quot;++id,name,age&quot;</span>
<span class="p">});</span>
<span class="c1">//@ts-ignore</span>
<span class="kr">const</span> <span class="nx">friendsTable</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span> <span class="nx">as</span> <span class="nx">Table</span><span class="p">;</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="s1">&#39;rw&#39;</span><span class="p">,</span> <span class="nx">friendsTable</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">joseCount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">friendsTable</span><span class="p">.</span><span class="nx">where</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Jose&#39;</span> <span class="p">}).</span><span class="nx">count</span><span class="p">();</span>
  <span class="kd">let</span> <span class="nx">hasJose</span> <span class="o">=</span> <span class="nx">joseCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasJose</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">friendsTable</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Jose&#39;</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">21</span> <span class="p">});</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Added</span> <span class="nx">friend</span> <span class="kd">with</span> <span class="nx">id</span> <span class="nx">$</span><span class="p">{</span><span class="nx">id</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">youngFriends</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">friendsTable</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">).</span><span class="nx">below</span><span class="p">(</span><span class="mi">25</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">My</span> <span class="nx">young</span> <span class="nx">friends</span><span class="err">：`</span><span class="p">,</span> <span class="nx">youngFriends</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Class的写法</span>
<span class="kr">import</span> <span class="nx">Dexie</span><span class="p">,</span> <span class="p">{</span> <span class="nx">Table</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;dexie&#39;</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">Friend</span> <span class="p">{</span>
  <span class="nx">id</span><span class="o">?:</span> <span class="nx">number</span><span class="p">;</span>
  <span class="nx">name</span><span class="o">?:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">age</span><span class="o">?:</span> <span class="nx">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">FriendDataBase</span> <span class="kr">extends</span> <span class="nx">Dexie</span> <span class="p">{</span>
  <span class="kr">public</span> <span class="nx">friends</span><span class="o">:</span> <span class="nx">Dexie</span><span class="p">.</span><span class="nx">Table</span><span class="o">&lt;</span><span class="nx">Friend</span><span class="p">,</span> <span class="nx">number</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="kr">public</span> <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="s1">&#39;FriendDataBase&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
      <span class="nx">friends</span><span class="o">:</span> <span class="s1">&#39;++id,name,age&#39;</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">friends</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;friends&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FriendDataBase</span><span class="p">();</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="s1">&#39;rw&#39;</span><span class="p">,</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">((</span><span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">where</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Josephine&#39;</span> <span class="p">}).</span><span class="nx">count</span><span class="p">())</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Josephine&quot;</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">21</span> <span class="p">});</span>
    <span class="nx">alert</span><span class="p">(</span><span class="err">`</span><span class="nx">Addded</span> <span class="nx">friend</span> <span class="kd">with</span> <span class="nx">id</span> <span class="nx">$</span><span class="p">{</span><span class="nx">id</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kr">const</span> <span class="nx">youngFriends</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">).</span><span class="nx">below</span><span class="p">(</span><span class="mi">25</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">My</span> <span class="nx">young</span> <span class="nx">friends</span><span class="err">：`</span><span class="p">,</span> <span class="nx">youngFriends</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">})</span>
</pre></div>

</code></pre>
<h2 id="dexie-doc">Dexie Doc</h2>
<p>Dexie V3.2及以后的版本，原生是支持响应式的。在V3.2版本中，我们引入了实时查询的功能。如果数据库里数据改变了，一个二叉范围树算法会高效地计算出这些改变会影响到的查询。</p>
<p>如果影响到了查询，会执行用户指定的回调，用户可以在指定的回调中重新渲染组件。</p>
<h3 id="-dexie">安装Dexie</h3>
<pre><code class="lang-bash"><div class="highlight"><pre>npm i dexie 
</pre></div>

</code></pre>
<h3 id="-db">创建db</h3>
<p>应用一般只有会一个Dexie实例，这也是你声明你需要的表及其索引的地方。Dexie实例是单例的，一般不需要懒创建它。在db的模块中导出db实例，以供其它模块使用。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">import</span> <span class="nx">Dexie</span> <span class="nx">from</span> <span class="s1">&#39;dexie&#39;</span><span class="p">;</span>

<span class="kr">export</span> <span class="kr">interface</span> <span class="nx">Friend</span> <span class="p">{</span>
  <span class="nx">id</span><span class="o">?:</span> <span class="nx">number</span><span class="p">;</span>
  <span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">age</span><span class="o">:</span> <span class="nx">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kr">class</span> <span class="nx">MyDexie</span> <span class="kr">extends</span> <span class="nx">Dexie</span> <span class="p">{</span>
  <span class="nx">friends</span><span class="o">:</span> <span class="nx">Dexie</span><span class="p">.</span><span class="nx">Table</span><span class="o">&lt;</span><span class="nx">Friend</span><span class="p">,</span> <span class="nx">number</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="s1">&#39;MyDataBae&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
      <span class="nx">friends</span><span class="o">:</span> <span class="s1">&#39;++id,name,age&#39;</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">friends</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;friends&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyDexie</span><span class="p">();</span>
</pre></div>

</code></pre>
<h3 id="-">添加数据</h3>
<p>添加数据到DB可以调用Table.add，Table.put，Table.update和Collection.modify。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">btnAdd</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#btnAdd&#39;</span><span class="p">);</span>
  <span class="nx">btnAdd</span><span class="o">?</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">txtName</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#txtName&#39;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">HTMLInputElement</span><span class="p">;</span>
      <span class="kr">const</span> <span class="nx">txtAge</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#txtAge&#39;</span><span class="p">)</span> <span class="nx">as</span> <span class="nx">HTMLInputElement</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">txtName</span><span class="o">?</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="o">!</span><span class="nx">txtAge</span><span class="o">?</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="err">`请输入姓名和年龄！`</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">//@ts-ignore</span>
      <span class="kd">let</span> <span class="nx">db</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">myDB</span><span class="p">;</span>
      <span class="kr">const</span> <span class="nx">addId</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">txtName</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="nb">Number</span><span class="p">.</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">txtAge</span><span class="o">?</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">});</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">New</span> <span class="nx">Friend</span> <span class="nx">Id</span> <span class="nx">is</span> <span class="nx">$</span><span class="p">{</span><span class="nx">addId</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">})</span>

<span class="p">})</span>
</pre></div>

</code></pre>
<h3 id="-">查询数据</h3>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">queryAllFriends</span><span class="p">()</span> <span class="p">{</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">myDB</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span> <span class="p">})</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h3 id="-">带参数查询数据</h3>
<p>where指定字段，然后指定条件。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">async</span> <span class="kd">function</span> <span class="nx">queryWithAgeParams</span><span class="p">(</span><span class="nx">minAge</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">maxAge</span><span class="o">:</span> <span class="nx">number</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">friends</span> <span class="o">=</span> <span class="nx">await</span> <span class="nb">window</span><span class="p">.</span><span class="nx">myDB</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">).</span><span class="nx">between</span><span class="p">(</span><span class="nx">minAge</span><span class="p">,</span> <span class="nx">maxAge</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">friends</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h2 id="quick-reference">Quick Reference</h2>
<h3 id="-">声明数据库</h3>
<p>注意：不像SQL中那样，不用声明每一个字段值和类型。你只需要声明你想要添加索引的字段。</p>
<p>++代表，自动增加的key。&amp;表示Unique，*表示MultiEntey索引，[A+B]表示混合索引。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">import</span> <span class="nx">Dexie</span> <span class="nx">from</span> <span class="s1">&#39;dexie&#39;</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">Friend</span> <span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">age</span><span class="o">:</span> <span class="nx">number</span><span class="p">;</span>
  <span class="nx">id</span><span class="o">?:</span> <span class="nx">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">MyDexieDb</span> <span class="kr">extends</span> <span class="nx">Dexie</span> <span class="p">{</span>
  <span class="nx">friends</span><span class="o">:</span> <span class="nx">Dexie</span><span class="p">.</span><span class="nx">Table</span><span class="o">&lt;</span><span class="nx">Friend</span><span class="p">,</span> <span class="nx">number</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">gameSessions</span><span class="o">:</span> <span class="nx">Dexie</span><span class="p">.</span><span class="nx">Table</span><span class="o">&lt;</span><span class="nx">number</span><span class="p">,</span> <span class="nx">number</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="s1">&#39;MyDataBase&#39;</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
      <span class="nx">friends</span><span class="o">:</span> <span class="s1">&#39;++id,name,age,*tags&#39;</span><span class="p">,</span>
      <span class="nx">gameSessions</span><span class="o">:</span> <span class="s1">&#39;id,score&#39;</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">friends</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;friends&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gameSessions</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;gameSessions&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h4 id="multientry-">MultiEntry索引</h4>
<p>MultiEntry的索引表示的是索引属性的值是数组值。每一个数组中的值会指向自身所在的相同的记录。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">class</span> <span class="nx">MyBookDb</span> <span class="kr">extends</span> <span class="nx">Dexie</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="s1">&#39;BookDB&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
      <span class="nx">books</span><span class="o">:</span> <span class="s1">&#39;id,author,name,*categories&#39;</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">books</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;books&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">addBook</span><span class="p">(</span><span class="nx">bookItem</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">bookItem</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">queryBookByCategory</span><span class="p">(</span><span class="nx">category</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;categories&#39;</span><span class="p">).</span><span class="nx">equals</span><span class="p">(</span><span class="nx">category</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyBookDb</span><span class="p">();</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">addBook</span><span class="p">({</span>
  <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Under the Demo&quot;</span><span class="p">,</span>
  <span class="nx">author</span><span class="o">:</span> <span class="s2">&quot;Stephen King&quot;</span><span class="p">,</span>
  <span class="nx">categories</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;sci-fi&#39;</span><span class="p">,</span> <span class="s1">&#39;thriller&#39;</span><span class="p">]</span>
<span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">queryBookByCategory</span><span class="p">(</span><span class="s1">&#39;sci-fi&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">queryBookByCategory</span><span class="err">`</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<p>当使用MultiEntry索引查询时，有一定的概率会得到多条相同的记录。这种情况下需要使用Collection.distinct来去除重复记录。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">//</span>
<span class="nx">queryBooksByMultiCategory</span><span class="p">(</span><span class="nx">categoryArr</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;categories&#39;</span><span class="p">).</span><span class="nx">anyOf</span><span class="p">(...</span><span class="nx">categoryArr</span><span class="p">).</span><span class="nx">distinct</span><span class="p">().</span><span class="nx">toArray</span><span class="p">();</span>
<span class="p">}</span>
<span class="c1">//</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">queryBooksByMultiCategory</span><span class="p">([</span><span class="s1">&#39;sci-fi&#39;</span><span class="p">,</span> <span class="s1">&#39;thriller&#39;</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">queryBooksByMultiCategory</span><span class="err">`</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">})</span>
</pre></div>

</code></pre>
<h4 id="-">联合索引</h4>
<p>一个联合索引基于若干个keyPaths。它可以高效率地索引多个属性值。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">interface</span> <span class="nx">Person</span> <span class="p">{</span>
  <span class="nx">id</span><span class="o">:</span> <span class="nx">number</span><span class="p">;</span>
  <span class="nx">firstName</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">lastName</span><span class="o">:</span> <span class="nx">string</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">MyPeopleDb</span> <span class="kr">extends</span> <span class="nx">Dexie</span> <span class="p">{</span>
  <span class="nx">persons</span><span class="o">:</span> <span class="nx">Dexie</span><span class="p">.</span><span class="nx">Table</span><span class="o">&lt;</span><span class="nx">Person</span><span class="p">,</span> <span class="nx">number</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="s1">&#39;PeopleDB&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
      <span class="nx">persons</span><span class="o">:</span> <span class="s1">&#39;id,[firstName+lastName]&#39;</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">persons</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;persons&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">addPerson</span><span class="p">(</span><span class="nx">personItem</span><span class="o">:</span> <span class="nx">Person</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">persons</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">personItem</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">queryPersonByName</span><span class="p">(</span><span class="nx">nameArr</span><span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">persons</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;[firstName+lastName]&#39;</span><span class="p">).</span><span class="nx">equals</span><span class="p">(</span><span class="nx">nameArr</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyPeopleDb</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">addPerson</span><span class="p">({</span>
  <span class="nx">id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">firstName</span><span class="o">:</span> <span class="s2">&quot;White&quot;</span><span class="p">,</span>
  <span class="nx">lastName</span><span class="o">:</span> <span class="s2">&quot;King&quot;</span><span class="p">,</span>
<span class="p">});</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">addPerson</span><span class="p">({</span>
  <span class="nx">id</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nx">firstName</span><span class="o">:</span> <span class="s2">&quot;White&quot;</span><span class="p">,</span>
  <span class="nx">lastName</span><span class="o">:</span> <span class="s2">&quot;Queen&quot;</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>

</code></pre>
<h4 id="-">联合索引查询</h4>
<p>可以使用属性和属性值的对象来查询。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">persons</span><span class="p">.</span><span class="nx">where</span><span class="p">({</span> <span class="nx">firstName</span><span class="o">:</span> <span class="s1">&#39;White&#39;</span><span class="p">,</span> <span class="nx">lastName</span><span class="o">:</span> <span class="s1">&#39;Queen&#39;</span> <span class="p">}).</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">res</span> <span class="nx">is</span> <span class="err">`</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">})</span>
</pre></div>

</code></pre>
<p>也可以直接直接使用索引名称来查询。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">persons</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;[firstName+lastName]&#39;</span><span class="p">).</span><span class="nx">equals</span><span class="p">([</span><span class="s1">&#39;White&#39;</span><span class="p">,</span> <span class="s1">&#39;Queen&#39;</span><span class="p">]).</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">res</span> <span class="nx">is</span> <span class="err">`</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<h4 id="-">联合索引是如何工作的？</h4>
<p>联合索引在IndexedDB中存储为数组。</p>
<h4 id="-">只查询第一个属性值</h4>
<p>可以只查询firstName=&#39;xxx&#39;的所有记录。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">persons</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;[firstName+lastName]&#39;</span><span class="p">).</span><span class="nx">between</span><span class="p">([</span><span class="s1">&#39;White&#39;</span><span class="p">,</span> <span class="nx">Dexie</span><span class="p">.</span><span class="nx">minKey</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;White&#39;</span><span class="p">,</span> <span class="nx">Dexie</span><span class="p">.</span><span class="nx">maxKey</span><span class="p">]).</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">res</span> <span class="nx">is</span> <span class="err">`</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">})</span>
</pre></div>

</code></pre>
<p>从Dexie3.x开始，联合索引开始添加虚拟索引，一般是联合索引的第一个字段。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">persons</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;firstName&#39;</span><span class="p">).</span><span class="nx">equals</span><span class="p">(</span><span class="s2">&quot;White&quot;</span><span class="p">).</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">res</span> <span class="nx">is</span> <span class="err">`</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<p>注意：只有联合索引的第一个字段可以单独使用。对于任何支持复合索引的BTree数据库，这都是相同的规则。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">persons</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;[firstName+lastName]&#39;</span><span class="p">).</span><span class="nx">anyOf</span><span class="p">([[</span><span class="s1">&#39;White&#39;</span><span class="p">,</span> <span class="s1">&#39;King&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;White&#39;</span><span class="p">,</span> <span class="s1">&#39;Queen&#39;</span><span class="p">]]).</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">res</span> <span class="nx">is</span> <span class="err">`</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<h4 id="-">联合主键</h4>
<p>可以使用联合主键，只是该键不能自加。</p>
<pre><code class="lang-js"><div class="highlight"><pre>  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
      <span class="kr">super</span><span class="p">(</span><span class="s1">&#39;PeopleDB&#39;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
          <span class="nx">personsNew</span><span class="o">:</span> <span class="s1">&#39;[firstName+lastName]&#39;</span>
      <span class="p">});</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">persons</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;personsNew&#39;</span><span class="p">);</span>
  <span class="p">}</span>
</pre></div>

</code></pre>
<h4 id="-">浏览器限制</h4>
<p>IE，非Chromium的Edge，和低于10的Safari不支持联合索引，也不支持联合索引做主键。你可以声明联合索引，但在使用where(&#39;[x+y]&#39;)时会报错。</p>
<p>但是使用对象查询参数时，该查询可以在所有浏览器上运行。如果浏览器支持联合索引，则使用联合索引，如果浏览器不支持联合索引，则使用简单索引，如果这些都不支持，则使用全表扫描然后过滤即可。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">table</span><span class="p">.</span><span class="nx">where</span><span class="p">({</span>
   <span class="nx">prop1</span><span class="o">:</span> <span class="nx">value1</span><span class="p">,</span>
   <span class="nx">prop2</span><span class="o">:</span> <span class="nx">value2</span><span class="p">,</span>
   <span class="p">...</span>
<span class="p">})</span>
</pre></div>

</code></pre>
<h4 id="-orderby">使用OrderBy</h4>
<p>如果联合索引是&#39;[firstName+lastName]&#39;，table.orderBy会先按firstName，再按lastName进行排序。</p>
<p>排序算法不止在调用orderBy时生效，在使用where字句时也会生效。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">persons</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;[firstName+lastName]&#39;</span><span class="p">).</span><span class="nx">between</span><span class="p">([</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]).</span><span class="nx">toArray</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<p>如果某个对象缺少firstName或lastName，则不会出现在结果中。联合索引只包含两个字段均有合法值得对象。</p>
<p>如果你的应用需要按几种方式排序，你可以增加多个联合顺序不同的联合索引。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
    <span class="nx">people</span><span class="o">:</span> <span class="err">`</span>
      <span class="o">++</span><span class="nx">id</span><span class="p">,</span>
      <span class="p">[</span><span class="nx">firstName</span><span class="o">+</span><span class="nx">lastName</span><span class="p">],</span>
      <span class="p">[</span><span class="nx">lastName</span><span class="o">+</span><span class="nx">firstName</span><span class="p">]</span><span class="err">`</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<h3 id="upgrade">upgrade</h3>
<pre><code class="lang-ts"><div class="highlight"><pre><span class="kr">class</span> <span class="nx">MyDB</span> <span class="kr">extends</span> <span class="nx">Dexie</span> <span class="p">{</span>
    <span class="kr">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="kr">super</span><span class="p">(</span><span class="s1">&#39;MyDB&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
            <span class="nx">friends</span><span class="o">:</span> <span class="s1">&#39;++id,name,age&#39;</span><span class="p">,</span>
            <span class="nx">gameSessions</span><span class="o">:</span> <span class="s1">&#39;id,score&#39;</span>
        <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">friends</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="err">`</span><span class="nx">friends</span><span class="err">`</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">gameSessions</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="err">`</span><span class="nx">gameSessions</span><span class="err">`</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kr">const</span> <span class="nx">myDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyDB</span><span class="p">();</span>
</pre></div>

</code></pre>
<p>注意：只有存入数据后，indexedDB中才会出现表结构。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">class</span> <span class="nx">MyDB</span> <span class="kr">extends</span> <span class="nx">Dexie</span> <span class="p">{</span>
  <span class="nx">friends</span><span class="o">:</span> <span class="nx">Dexie</span><span class="p">.</span><span class="nx">Table</span><span class="o">&lt;</span><span class="p">{</span> <span class="nx">id</span><span class="o">?:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="nx">number</span> <span class="p">},</span> <span class="nx">number</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nx">gameSessions</span><span class="o">:</span> <span class="nx">Dexie</span><span class="p">.</span><span class="nx">Table</span><span class="o">&lt;</span><span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">score</span><span class="o">:</span> <span class="nx">number</span> <span class="p">},</span> <span class="nx">number</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="s1">&#39;MyDB&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
      <span class="nx">friends</span><span class="o">:</span> <span class="s1">&#39;++id,[firstName+lastName],yearOfBirth,*tags&#39;</span><span class="p">,</span>
      <span class="nx">gameSessions</span><span class="o">:</span> <span class="kc">null</span>
    <span class="p">}).</span><span class="nx">upgrade</span><span class="p">(</span><span class="nx">tx</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// modify可以更改</span>
      <span class="k">return</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s2">&quot;friends&quot;</span><span class="p">).</span><span class="nx">modify</span><span class="p">(</span><span class="nx">friend</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">friend</span><span class="p">.</span><span class="nx">firstName</span> <span class="o">=</span> <span class="nx">friend</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
          <span class="nx">friend</span><span class="p">.</span><span class="nx">lastName</span> <span class="o">=</span> <span class="nx">friend</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
          <span class="nx">friend</span><span class="p">.</span><span class="nx">birthDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">-</span> <span class="nx">friend</span><span class="p">.</span><span class="nx">age</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
          <span class="k">delete</span> <span class="nx">friend</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
          <span class="k">delete</span> <span class="nx">friend</span><span class="p">.</span><span class="nx">age</span><span class="p">;</span>
      <span class="p">});</span>
   <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">friends</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="err">`</span><span class="nx">friends</span><span class="err">`</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gameSessions</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="err">`</span><span class="nx">gameSessions</span><span class="err">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">myDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyDB</span><span class="p">();</span>
</pre></div>

</code></pre>
<p>注意：只有存入新数据后，indexedDB才会变更表结构和索引。</p>
<h3 id="class-binding">Class Binding</h3>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">class</span> <span class="nx">Friend</span> <span class="p">{</span>
  <span class="nx">id</span><span class="o">!:</span> <span class="nx">number</span><span class="p">;</span>
  <span class="nx">firstName</span><span class="o">!:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">lastName</span><span class="o">!:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">yearOfBirth</span><span class="o">!:</span> <span class="nx">number</span><span class="p">;</span>
  <span class="nx">tags</span><span class="o">!:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="nx">save</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">myDB</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">get</span> <span class="nx">age</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">yearOfBirth</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">myDB</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">mapToClass</span><span class="p">(</span><span class="nx">Friend</span><span class="p">);</span>
</pre></div>

</code></pre>
<p>调用该方法会使从friends取出的对象会成为你绑定的类的实例。所以原型链上的方法都可以使用。</p>
<p>实现上，原始的DB对象通过Object.create的方法来浅拷贝到你绑定的类的实例上。</p>
<p>这个功能只适用于Table.get，Table.toArray，Table.each，Collection.toArray()，Collection.each()，Collection.first()，Collection.last()。</p>
<p>不适用于过滤的查询，Collection.filter，Collection.and，Collection.modify，Collection.Raw。</p>
<p>值得注意的是，它不适用于任何钩子函数。Table.hook(&#39;creating&#39;)，Table.hook(&#39;update&#39;)，Table.hook(<code>reading</code>)，Table.hook(‘deleting’)。</p>
<h3 id="add-items">Add Items</h3>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">myDB</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">firstName</span><span class="o">:</span> <span class="s1">&#39;White&#39;</span><span class="p">,</span><span class="nx">lastName</span><span class="o">:</span> <span class="s1">&#39;If&#39;</span><span class="p">,</span><span class="nx">yearOfBirth</span><span class="o">:</span> <span class="mi">1999</span><span class="p">,</span> <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span><span class="s1">&#39;two&#39;</span><span class="p">,</span><span class="s1">&#39;three&#39;</span><span class="p">]});</span>
</pre></div>

</code></pre>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">myDB</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">bulkAdd</span><span class="p">([{</span><span class="nx">id</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">name</span><span class="o">:</span><span class="s1">&#39;BeiBianliu&#39;</span><span class="p">},{</span><span class="nx">id</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span><span class="nx">name</span><span class="o">:</span><span class="s1">&#39;XiBianCao&#39;</span><span class="p">}])</span>
</pre></div>

</code></pre>
<p>如果你有大量的对象要存储到ObjectStore中，使用bulkAdd会比add更快一些。</p>
<h3 id="update-items">Update Items</h3>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">put</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">33</span><span class="p">});</span>
</pre></div>

</code></pre>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">bulkPut</span><span class="p">([</span>
    <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Foo2&quot;</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">34</span><span class="p">},</span>
    <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Bar2&quot;</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">44</span><span class="p">}</span>
<span class="p">]);</span>
</pre></div>

</code></pre>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">await</span> <span class="nx">myDB</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="mi">1</span><span class="p">,{</span><span class="nx">name</span><span class="o">:</span><span class="s1">&#39;Bar&#39;</span><span class="p">})</span>
</pre></div>

</code></pre>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">await</span> <span class="nx">myDB</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">).</span><span class="nx">equals</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">modify</span><span class="p">({</span><span class="nx">discount</span><span class="o">:</span><span class="mf">0.5</span><span class="p">})</span>
</pre></div>

</code></pre>
<h3 id="delete-items">Delete Items</h3>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</pre></div>

</code></pre>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">bulkDelete</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]);</span>
</pre></div>

</code></pre>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">logEntries</span>
    <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">).</span><span class="nx">below</span><span class="p">(</span><span class="nx">oneWeekAgo</span><span class="p">)</span>
    <span class="p">.</span><span class="k">delete</span><span class="p">();</span>
</pre></div>

</code></pre>
<h3 id="queryitems">QueryItems</h3>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">const</span> <span class="nx">someFriends</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span>
    <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">).</span><span class="nx">between</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">offset</span><span class="p">(</span><span class="mi">150</span><span class="p">).</span><span class="nx">limit</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">toArray</span><span class="p">();</span>
</pre></div>

</code></pre>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span>
    <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">).</span><span class="nx">equalsIgnoreCase</span><span class="p">(</span><span class="s2">&quot;josephine&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">friend</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Found Josephine&quot;</span><span class="p">,</span> <span class="nx">friend</span><span class="p">);</span>
    <span class="p">});</span>
</pre></div>

</code></pre>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">const</span> <span class="nx">abcFriends</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span>
    <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">startsWithAnyOfIgnoreCase</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">toArray</span><span class="p">();</span>
</pre></div>

</code></pre>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span>
    <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">inAnyRange</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">18</span><span class="p">],</span> <span class="p">[</span><span class="mi">65</span><span class="p">,</span> <span class="kc">Infinity</span><span class="p">]])</span>
    <span class="p">.</span><span class="nx">modify</span><span class="p">({</span><span class="nx">discount</span><span class="o">:</span> <span class="mf">0.5</span><span class="p">});</span>
</pre></div>

</code></pre>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kr">const</span> <span class="nx">friendsContainingLetterA</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span>
    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">friend</span> <span class="o">=&gt;</span> <span class="sr">/a/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">friend</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">toArray</span><span class="p">();</span>
</pre></div>

</code></pre>
<h4 id="joining">Joining</h4>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dexie</span><span class="p">(</span><span class="s1">&#39;music&#39;</span><span class="p">);</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">version</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">stores</span><span class="p">({</span>
    <span class="nx">genres</span><span class="o">:</span> <span class="s1">&#39;++id,name&#39;</span><span class="p">,</span>
    <span class="nx">albums</span><span class="o">:</span> <span class="s1">&#39;++id,name,year,*tracks&#39;</span><span class="p">,</span>
    <span class="nx">bands</span><span class="o">:</span> <span class="s1">&#39;++id,name,*albumIds,genreId&#39;</span>
<span class="p">});</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">getBandsStartingWithA</span> <span class="p">()</span> <span class="p">{</span>

    <span class="kr">const</span> <span class="nx">bands</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">bands</span>
        <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">toArray</span><span class="p">();</span>

    <span class="nx">await</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span> <span class="p">(</span><span class="nx">bands</span><span class="p">.</span><span class="nx">map</span> <span class="p">(</span><span class="nx">async</span> <span class="nx">band</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="p">[</span><span class="nx">band</span><span class="p">.</span><span class="nx">genre</span><span class="p">,</span> <span class="nx">band</span><span class="p">.</span><span class="nx">albums</span><span class="p">]</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
        <span class="nx">db</span><span class="p">.</span><span class="nx">genres</span><span class="p">.</span><span class="nx">get</span> <span class="p">(</span><span class="nx">band</span><span class="p">.</span><span class="nx">genreId</span><span class="p">),</span>
        <span class="nx">db</span><span class="p">.</span><span class="nx">albums</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">).</span><span class="nx">anyOf</span><span class="p">(</span><span class="nx">band</span><span class="p">.</span><span class="nx">albumIds</span><span class="p">).</span><span class="nx">toArray</span><span class="p">()</span>
      <span class="p">]);</span>
    <span class="p">}));</span>

    <span class="k">return</span> <span class="nx">bands</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h3 id="ongoing-transcation">Ongoing Transcation</h3>
<p>原子变更</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">async</span> <span class="kd">function</span> <span class="nx">addComment</span><span class="p">(</span><span class="nx">friendId</span><span class="p">,</span> <span class="nx">comment</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span>
        <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="nx">friendId</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">modify</span><span class="p">(</span><span class="nx">friend</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">friend</span><span class="p">.</span><span class="nx">comments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">comment</span><span class="p">);</span>
        <span class="p">});</span>
<span class="p">}</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">spreadYourLove</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="s1">&#39;rw&#39;</span><span class="p">,</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">goodFriendKeys</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">goodFriends</span><span class="p">().</span><span class="nx">primaryKeys</span><span class="p">();</span>
        <span class="nx">await</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
            <span class="nx">goodFriendKeys</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">id</span> <span class="o">=&gt;</span> <span class="nx">addComment</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="s2">&quot;I like you!&quot;</span><span class="p">))</span>
        <span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>上面的代码展示了如何复用transcation来执行多个操作。</p>
<h2 id="working-with-async-apis">Working With Async APIS</h2>
<p>Dexie.js使用了异步API，在同步API中，错误处理使用异常捕获机制。这非常方便，因为你无需在各处检查代码，只需要在更高层次上捕获异常即可。</p>
<p>异步API通常在操作完成时发出success和error事件。</p>
<p>IndexedDB同时使用了异常和错误事件来通知调用者，你需要同时使用try/catch和onerror来处理每一个请求。</p>
<p>Dexie.js使用Promise来处理错误。</p>
<h2 id="promise-specific-data-zone-">Promise-Specific Data(Zone)</h2>
<p>Dexie Promise支持一种类似于本地线程存储的技术。这可以使一些静态属性绑定到执行中的Promise和它的子Promise中。</p>
<p>Dexie.js和它的transcation API重度依赖Transcation Zones，因为代码需要知道当前执行中的Transcation，而我们又不想把transcation传来传去。</p>
<h3 id="promise-psd">Promise.PSD</h3>
<p>Dexie.Promise.PSD是一个自定义的Zone系统来维护进行中的DB Transcations。从Dexie 2.0.0-beta.4开始，Dexie的Zone系统可以支持await表达式。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="c1">// Create a PSD scope</span>
<span class="nx">Dexie</span><span class="p">.</span><span class="nx">Promise</span><span class="p">.</span><span class="nx">newPSD</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> 
    <span class="c1">// Put something in it.</span>
    <span class="nx">Dexie</span><span class="p">.</span><span class="nx">Promise</span><span class="p">.</span><span class="nx">PSD</span><span class="p">.</span><span class="nx">promiseSpecificVariable</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> 
    <span class="c1">// Create a promise that uses it</span>
    <span class="k">new</span> <span class="nx">Dexie</span><span class="p">.</span><span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">then</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="c1">// This callback will get same PSD instance as was active when .then() was called</span>
        <span class="nx">assert</span> <span class="p">(</span><span class="nx">Dexie</span><span class="p">.</span><span class="nx">Promise</span><span class="p">.</span><span class="nx">PSD</span><span class="p">.</span><span class="nx">promiseSpecificVariable</span> <span class="o">==</span> <span class="mi">3</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<p>与特定于线程的数据类似，特定于Promise的数据包含绑定到Promise流的静态数据。</p>
<h4 id="-">目的</h4>
<p>在线程的世界里，特定于线程的数据可以被用来存储一些状态到当前执行的线程上。</p>
<p>授权引擎经常使用特定于线程的数据来保存授权规则，而不是将对象传来传去。</p>
<p>日志记录框架还依赖于线程特定的内容，因为用户可以不用传递userName等之类的数据来记录内容。</p>
<p>重入互斥锁是另一种重要模式，它使一个函数能够锁定互斥体，然后调用其它子函数，这些子函数也会锁定相同的互斥锁。</p>
<p>在Dexie中，PSD用于：</p>
<p>1、维护transaction scopes。</p>
<p>2、对事务启用可重用互斥锁。</p>
<p>3、在db.open完成之前，可以订阅db.ready事件。</p>
<h2 id="-">异常处理</h2>
<p>在Dexie中，只有Promise.catch可以捕获异常。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="s1">&#39;rw&#39;</span><span class="p">,</span><span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">,</span> <span class="p">()</span><span class="o">=&gt;</span><span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;test error&#39;</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">})</span>
</pre></div>

</code></pre>
<h3 id="catch-">catch意味这异常处理</h3>
<p>catch意味着异常已经处理，如果你想终止transcation，需要throw这个错误。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">transcation</span><span class="p">(</span><span class="s1">&#39;rw&#39;</span><span class="p">,</span><span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">,()</span><span class="o">=&gt;</span><span class="p">{</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">name</span><span class="o">:</span><span class="s1">&#39;Foo&#39;</span><span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Failed to add Foo friend.&quot;</span><span class="p">);</span>
    <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
  <span class="p">})</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<h2 id="-transactions">使用transactions</h2>
<p>当你想处理多个操作时，你最好使用transcations。这样做，有以下好处：</p>
<p>1、如果在数据修改过程中发生了一些错误，错误事件或异常，你的修改会回滚。</p>
<p>2、不需要处理Promise异常了，你只需要处理transcation的异常。</p>
<p>3、你可以同步执行所有写入操作，而无需等待上一个完成才能开始下一个。</p>
<p>4、读操作可以在写操作的下一行执行，这是因为当前事务中存在被挂起的写操作时，其它操作都需要排队。</p>
<p>5、没有一个错误会错过。因为在catch字句里会捕捉所有的错误。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="s1">&#39;rw&#39;</span><span class="p">,</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">,</span> <span class="nx">db</span><span class="p">.</span><span class="nx">pets</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Any database error event that occur will abort transaction and</span>
    <span class="c1">// be sent to the catch() method below.</span>
    <span class="c1">// The exact same rule if any exception is thrown what so ever.</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">pets</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Bamse&#39;</span><span class="p">,</span> <span class="nx">kind</span><span class="o">:</span> <span class="s1">&#39;cat&#39;</span><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">petId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Kate&#39;</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">89</span><span class="p">,</span> <span class="nx">pets</span><span class="o">:</span> <span class="p">[</span><span class="nx">petId</span><span class="p">]});</span>
    <span class="p">});</span>

<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Log or display the error</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">stack</span> <span class="o">||</span> <span class="nx">error</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<p>当使用Transcations时，你可以查询到刚刚add，put，update，delete和modify操作的数据，而不用等到更新操作结束。</p>
<p>等待的操作框架会处理。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="s2">&quot;rw&quot;</span><span class="p">,</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Ulla Bella&quot;</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">87</span><span class="p">,</span> <span class="nx">isCloseFriend</span><span class="o">:</span> <span class="mi">0</span> <span class="p">});</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Elna&quot;</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="mi">99</span><span class="p">,</span> <span class="nx">isCloseFriend</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">).</span><span class="nx">above</span><span class="p">(</span><span class="mi">65</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">friend</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Retired friend: &quot;</span> <span class="o">+</span> <span class="nx">friend</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<h2 id="indexeddb-">IndexedDB事务会自动提交</h2>
<p>IndexedDB的事务，如果在某个事件循环中没有被使用，它就会被自动提交。</p>
<h2 id="-indexeddb-">嵌套的IndexedDB事务</h2>
<p>自动version 0.9.8以后，Dexie支持嵌套的事务。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="s1">&#39;rw&#39;</span><span class="p">,</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">,</span> <span class="nx">db</span><span class="p">.</span><span class="nx">pets</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// MAIN transaction block</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="s1">&#39;rw&#39;</span><span class="p">,</span> <span class="nx">db</span><span class="p">.</span><span class="nx">pets</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
       <span class="c1">// SUB transaction block</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<p>嵌套的事务的强大之处在于，使用事务的函数可以被更高级别的代码重用，该代码将其所有的调用转换为更大的事务。</p>
<h1 id="dexiedb-">DexieDB的最佳实践</h1>
<h2 id="-promise">熟悉Promise</h2>
<p>确保你了解Promise A+的基本规范。下面是测试代码：</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">doSomething</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Important: Understand why we use &#39;return&#39; here and what we actually return!</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">).</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">aFriend</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">aFriend</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span> <span class="c1">// Important: Understand what &#39;return&#39; means here!</span>
    <span class="p">}).</span><span class="nx">then</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">aFriendsId</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Important: Understand what it means to return another Promise here:</span>
        <span class="k">return</span> <span class="nx">fetch</span> <span class="p">(</span><span class="s1">&#39;https://blablabla/friends/&#39;</span> <span class="o">+</span> <span class="nx">aFriendsId</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h2 id="-catchpromise-">在catchPromise时要多思考</h2>
<p>catch了错误，没有重新抛出错误是不好的实践。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">somePromiseReturningFunc</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
        <span class="nx">age</span><span class="o">:</span> <span class="mi">40</span>
    <span class="p">}).</span><span class="k">catch</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>下面的做法要比上面的好不少，这样调用者会得到相关的错误信息。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">somePromiseReturningFunc</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
        <span class="nx">age</span><span class="o">:</span> <span class="mi">40</span>
    <span class="p">});</span>
    <span class="c1">// Don&#39;t catch! The caller wouldn&#39;t find out that an error occurred if you do!</span>
    <span class="c1">// We are returning a Promise, aren&#39;t we? Let caller catch it instead!</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>在transcation范围内，尤其如此。你catch了一个Promise，意味着你有优雅处理错误的方法。如果你没有，请不要catch它。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">myDataOperations</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="s1">&#39;rw&#39;</span><span class="p">,</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">,</span> <span class="nx">db</span><span class="p">.</span><span class="nx">pets</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">pets</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="nx">daddy</span><span class="o">:</span> <span class="nx">id</span><span class="p">});</span>
        <span class="p">}).</span><span class="nx">then</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">pets</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">).</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">).</span><span class="nx">toArray</span><span class="p">();</span>
        <span class="p">}).</span><span class="nx">then</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">pets</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//</span>
        <span class="p">});</span> <span class="c1">// Don&#39;t catch! Transaction SHOULD abort if error occur, shouldn&#39;t it?</span>
    <span class="p">});</span> <span class="c1">// Don&#39;t catch! Let the caller catch us instead! I mean we are returning a promise, aren&#39;t we?!</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>但是在事件处理器或顶层的Promise中，需要Catch。因为没有人会调用你，你需要处理这个错误，如果不你处理这个错误，这个错误就会到unhandlerejection事件中。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">somePromiseReturningFunc</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#appErrorLabel&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span> <span class="o">||</span> <span class="nx">err</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

</code></pre>
<p>某些时候，你对某些错误有合适的处理方式，这种情况下，你可以catch这个错误。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">getHillary</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span>
    <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;[firstName+lastName]&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">equals</span><span class="p">([</span><span class="s1">&#39;Hillary&#39;</span><span class="p">,</span> <span class="s1">&#39;Clinton&#39;</span><span class="p">])</span>
    <span class="p">.</span><span class="nx">toArray</span><span class="p">()</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="s1">&#39;DataError&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// May fail in IE/Edge because it lacks support for compound keys.</span>
      <span class="c1">// Use a fallback method:</span>
      <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span>
        <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;firstName&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="s1">&#39;Hillary&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">and</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">friend</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">friend</span><span class="p">.</span><span class="nx">lastName</span> <span class="o">==</span> <span class="s1">&#39;Clinton&#39;</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>如果只是为了log和debug，需要将错误err throw出去。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">myFunc</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">friends</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">});</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Failed to add foo!: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span> <span class="c1">// Re-throw the error to abort flow!</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
        <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">pets</span><span class="p">.</span><span class="nx">add</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="nx">daddy</span><span class="o">:</span> <span class="nx">id</span><span class="p">});</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Failed to add bar!: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span> <span class="c1">// Re-throw the error!</span>
    <span class="p">}).</span><span class="nx">then</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">});</span>
<span class="p">};</span>
</pre></div>

</code></pre>
<h2 id="-api">在事务中不要使用其它异步API</h2>
<p>IndexedDB的事务，如果在一个事件循环中没有被使用，就会自动提交。这意味着你不要在你事务中调用其它异步API。</p>
<p>如果你想要调用一个耗时短的Async-API，你需要使用Dexie.waitFor来保持事务。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">Dexie</span><span class="p">.</span><span class="nx">waitFor</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">timeout</span><span class="o">=</span><span class="mi">60000</span><span class="p">)</span>
</pre></div>

</code></pre>
<h2 id="-">参考文档</h2>
<p><a href="https://dexie.org/docs/Tutorial/React">https://dexie.org/docs/Tutorial/React</a></p>
<p><a href="https://dexie.org/docs/API-Reference#quick-reference">https://dexie.org/docs/API-Reference#quick-reference</a></p>
<p><a href="https://dexie.org/docs/Tutorial/Best-Practices">https://dexie.org/docs/Tutorial/Best-Practices</a></p>
</body>
</html>
