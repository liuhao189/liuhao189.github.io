<!DOCTYPE html>
<html>
<head>
  <title>Blink如何工作</title>
  <link rel="stylesheet" href="/note/note.css?ts=1650128309446">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"><link rel="shortcut icon" href="/ico.png"></head>
<body><script>var _hmt = _hmt || [];
(function () {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?256376ad73e3e50091706bb3c032e74c";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>
<h1 id="blink-">Blink如何工作</h1>
<p>开发Blink是困难的，对于新开发者来说，Blink有很多Blink自身的概念和一些为实现非常快速的渲染引擎而引入的编码约定。</p>
<p>对于有经验的Blink开发者来说也不简单，因为Blink对性能，内存和安全的要求非常高。</p>
<p>本文主要讲述Blink如何工作的概述，希望有助于Blink开发人员快速熟悉结构。</p>
<h2 id="blink-">Blink负责什么</h2>
<p>Blink是Web平台的渲染引擎。粗略地说，Blink实现了在浏览器选项卡中呈现内容的所有内容：</p>
<p>1、实现Web平台的规范，包括HTML，CSS和Web IDL。</p>
<p>2、嵌入V8并运行JS。</p>
<p>3、从底层网络堆栈请求资源。</p>
<p>4、构建DOM树。</p>
<p>5、计算样式和布局。</p>
<p>6、嵌入Chrome合成器并绘制图形。</p>
<p>Blink被很多软件通过内容公共API嵌入，如Chromium，Android Webview和Opera。</p>
<h2 id="-">进程-线程架构</h2>
<h3 id="-">进程</h3>
<p>Chromium使用多进程架构。Blink运行在渲染器进程中。</p>
<p>从概念上来讲，每个渲染器进程最多对应于一个站点。但是实际上，当用户打开太多选项卡或设备没有足够的RAM时，将每个渲染器进程限制为单个站点太重了。在这种情况下，渲染器进程可能被多个Tab或多个iframe共享。</p>
<p>渲染器进程在沙盒运行，Blink需要向浏览器进程发起系统调度请求，eg：文件访问、播放音频和访问用户配置文件数据(Cookie，密码)。</p>
<p>渲染器进程通过Mojo和浏览器进程进行通信，注意，过去使用Chromium IPC系统。</p>
<p>在Chromium方面，服务化正在进行，将浏览器进程抽象为一组服务。在Blink看来，Blink可以使用Mojo来和服务进程和浏览器进程通信。</p>
<h3 id="-">线程</h3>
<p>Blink有一个主线程，N个worker线程，还有一些内部的线程。</p>
<p>几乎所有重要的事都在主线程中。除了Workders以外的JS运行，DOM，CSS，样式和布局计算都在主线程。</p>
<p>Blink经过高度优化，以最大限度地提高主线程的性能。</p>
<p>Blink也可能创建多个worker线程来执行Web Workers，Service Workder和Worklets。</p>
<p>Blink和V8也会创建一系列内置进程来处理音频，数据库，垃圾回收器等。</p>
<p>对于跨线程通信，必须使用PostTask API进行消息传递。不鼓励使用共享内存变成，除非处于性能原因，这是为什么在Blink代码库中看不到很多互斥锁的原因。</p>
<h3 id="-blink">初始化和析构Blink</h3>
<p>Blink使用BlinkInitalizer::Initialize来初始化，需要在执行任何Blink代码之前调用该方法。</p>
<p>Blink不会析构，渲染器进程被强制退出，而不进行清理。一方面是为了性能原因，另一个原因是以优雅有序的方式清理渲染器进程中的资源非常困难。</p>
<h2 id="-">目录结构</h2>
<p>Content-Public-API是面向嵌入软件的API层，因为直接面向客户，需要小心维护。</p>
<p>Blink-Public-API是将third_party/blink的功能公开给Chromium的API层。</p>
<h2 id="wtf">WTF</h2>
<p>WTF是Blink专用的lib，代码位于platform/wtf。我们正试图尽可能地统一Chromium和Blink之间的编码基础，因此WTF应该很小。</p>
<p>这个库是必需的，因为有许多类型，容器和宏确实需要针对Blink的工作负载和Oilpan(Blink-GC)进行优化。</p>
<p>如果该类型的WTF中定义了，Blink应该使用WTF的类型，而不是使用base目录下定义的类型和std类库。较流行的类型是vectors，hashsets，hashmaps和strings。</p>
<p>Blink应该使用WTF::Vector，WTF::HashSet，WTF::HashMap，WTF::String而不是std::vector，std::set等。</p>
<h2 id="-">内存管理</h2>
<p>就Blink而言，你需要关心三个内存分配器：</p>
<p>1、PartitionAlloc。</p>
<p>2、Oilpan(Blink GC)。</p>
<p>3、malloc/free，new/delete</p>
<p>可以使用USEING_FAST_MALLOC在PartitionAlloc的堆中分配新对象。创建的对象的生命周期应该由scoped_ref ptr或std:unique_ptr来管理。强烈不建议手动管理对象内存。</p>
<p>你可以使用GarbageCollected在Oilpan的堆中分配新对象。对象的生命周期由垃圾回收器管理。你可以使用特殊的指针来引用Oilpan堆里的对象。</p>
<p>如果你不使用USEING_FAST_MALLOC或GarbageCollected，对象会分配到系统malloc的堆。Blink强烈不建议这样做。</p>
<p>所有的Blink对象应该分配在PartitionAlloc或GarbageCollected中。默认使用Oilpan；在对象的生命周期非常清晰&amp;使用std:unique_ptr或scoped_refptr足够，在Olipan中分配对象增加了复杂性，在Oilpan中分配对象增加了垃圾回收的运行压力时，才应该在PartitionAlloc中分配对象。</p>
<h2 id="-">任务调度</h2>
<p>为了提高渲染引擎的响应性，在Blink中的task应该尽可能异步执行。同步的IPC/Mojo或其它操作可能会耗费数毫秒的时间。</p>
<p>渲染引擎中的所有tasks应该添加到Blink Schedule中。Blink调度器维护了多个任务队列，可以智慧得确定任务的优先级，以最大限度地提高用户感知的性能。</p>
<h2 id="-domwindow">页面，框架，文档，DOMWindow</h2>
<p>Page：页面对应于选项卡的概念，每个渲染器进程可能包含多个选项卡。</p>
<p>Frame：框架包括主框架或iframe，每一个Page可能包含一个或多个以树状层次结构排列的Frames。</p>
<p>DOMWindow：JS中的window对象，每一个Frame都有一个DOMWindow。</p>
<p>Document：JS中的window.document对象，每一个Frame都有一个Document。</p>
<p>ExecutionContext：是一个抽象的执行环境上下文的概念。eg：Workder线程有WorkerGlobalScope。</p>
<p>渲染器进程：Page = 1:N；Page：Frame=1：N；Frame:DOMWindow:Document=1:1:1。</p>
<h2 id="-iframes-out-of-process-ifames-oopif-">进程外Iframes，Out-Of-Process Ifames（OOPIF）</h2>
<p>Site Isolation使得浏览器更加安全，但是也更加复杂了。Site Isolation主要指的是每一个Site需要一个单独的渲染器进程。</p>
<p>如果一个页面包含一个跨站点的iframe，那么这个Page可能在两个渲染器进程中。</p>
<p>在渲染器进程中的frame由LocalFrame表示，不在当前渲染器进程中的Frame由RemoteFrame表示。</p>
<p>在两个渲染器进程之间通信主要通过浏览器进程。</p>
<h2 id="-frame-document">分离的Frame和Document</h2>
<h2 id="-">参考文档</h2>
<p><a href="https://docs.google.com/document/d/1aitSOucL0VHZa9Z2vbRJSyAIsAz24kX8LFByQ5xQnUg/edit">https://docs.google.com/document/d/1aitSOucL0VHZa9Z2vbRJSyAIsAz24kX8LFByQ5xQnUg/edit</a></p>
</body>
</html>
