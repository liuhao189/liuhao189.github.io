<!DOCTYPE html>
<html>
<head>
  <title>Gataby-webpack</title>
  <link rel="stylesheet" href="/note/note.css?ts=1648480830010">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"><link rel="shortcut icon" href="/ico.png"></head>
<body><script>var _hmt = _hmt || [];
(function () {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?256376ad73e3e50091706bb3c032e74c";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>
<h1 id="gataby-webpack">Gataby-webpack</h1>
<p>在创建自定义webpack配置之前，建议先看看是否有gatsby的plugin已完成类似的功能。如果没有，而且你的配置具有通用性，可以考虑将该功能写为插件并贡献给社区。</p>
<p>自定义webpack配置主要在gatsby-node的onCreateWebpackConfig中定义。</p>
<p>在Gatsby在创建webpack配置时，这个方法会被调用。你设置的webpack配置会使用webpack-merge和默认的webpack配置合并。</p>
<p>gatsby在整个构建中需要用数次用到webpack配置，gatsby在调用onCreateWebpackConfig时会传入stage作为build type。</p>
<p>stage的值：</p>
<p>1、develop，gatsby develop命令时，有hot reload和CSS内容注入页面。</p>
<p>2、develop-html，和develop相同，但是没有react-hmre在babel的配置中来渲染HTML组件。</p>
<p>3、build-javascript，prodction的JS和CSS构建，创建基于路由的JS包和common chunks。</p>
<p>4、build-html，production的静态HTML页面。</p>
<h2 id="resolve-">resolve路径</h2>
<p>import Header from &#39;../../components/header&#39;配置下面的resolve路径，可以改为import Header from &#39;components/header&#39;。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">onCreateWebpackConfig</span> <span class="o">=</span> <span class="p">({</span><span class="nx">stage</span><span class="p">,</span> <span class="nx">actions</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">actions</span><span class="p">.</span><span class="nx">setWebpackConfig</span><span class="p">({</span>
    <span class="nx">resolve</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">modules</span><span class="o">:</span> <span class="p">[</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="s1">&#39;src&#39;</span><span class="p">),</span><span class="s1">&#39;node_modules&#39;</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h2 id="-yarn-non-webpack-">使用yarn来处理non-webpack工具</h2>
<p>使用resolve路径只能解决webpack内的引用问题，不能应用于其它工具。eg：ESLint，TypeScript。</p>
<p>但是使用yarn，最好的方式是在package.json中设置你的引用。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;hooks&quot;</span><span class="o">:</span> <span class="s2">&quot;link:./src/hooks&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h2 id="-babel-loader">修改Babel-loader</h2>
<p>可以使用下面的方法来修改babel的配置。</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">onCreateWebpackConfig</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">actions</span><span class="p">,</span> <span class="nx">loaders</span><span class="p">,</span> <span class="nx">getConfig</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">getConfig</span><span class="p">()</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">module</span><span class="p">.</span><span class="nx">rules</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1">// Omit the default rule where test === &#39;\.jsx?$&#39;</span>
    <span class="p">...</span><span class="nx">config</span><span class="p">.</span><span class="nx">module</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
      <span class="nx">rule</span> <span class="o">=&gt;</span> <span class="nb">String</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">test</span><span class="p">)</span> <span class="o">!==</span> <span class="nb">String</span><span class="p">(</span><span class="sr">/\.jsx?$/</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="c1">// Recreate it with custom exclude filter</span>
    <span class="p">{</span>
      <span class="c1">// Called without any arguments, `loaders.js()` will return an</span>
      <span class="c1">// object like:</span>
      <span class="c1">// {</span>
      <span class="c1">//   options: undefined,</span>
      <span class="c1">//   loader: &#39;/path/to/node_modules/gatsby/dist/utils/babel-loader.js&#39;,</span>
      <span class="c1">// }</span>
      <span class="c1">// Unless you&#39;re replacing Babel with a different transpiler, you probably</span>
      <span class="c1">// want this so that Gatsby will apply its required Babel</span>
      <span class="c1">// presets/plugins.  This will also merge in your configuration from</span>
      <span class="c1">// `babel.config.js`.</span>
      <span class="p">...</span><span class="nx">loaders</span><span class="p">.</span><span class="nx">js</span><span class="p">(),</span>
      <span class="nx">test</span><span class="o">:</span> <span class="sr">/\.jsx?$/</span><span class="p">,</span>
      <span class="c1">// Exclude all node_modules from transpilation, except for &#39;swiper&#39; and &#39;dom7&#39;</span>
      <span class="nx">exclude</span><span class="o">:</span> <span class="nx">modulePath</span> <span class="o">=&gt;</span>
        <span class="sr">/node_modules/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">modulePath</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="sr">/node_modules\/(swiper|dom7)/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">modulePath</span><span class="p">),</span>
    <span class="p">},</span>
  <span class="p">]</span>
  <span class="c1">// This will completely replace the webpack config with the modified object.</span>
  <span class="nx">actions</span><span class="p">.</span><span class="nx">replaceWebpackConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

</code></pre>
</body>
</html>
