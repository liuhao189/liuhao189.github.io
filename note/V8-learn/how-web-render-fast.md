# WebRender怎么保证渲染效率

## 绘制和合成的历史

注意：绘制和合成是浏览器差异比较大的部分。单平台浏览器(Edge和Safari)和跨平台浏览器(Firefox和Chrome)工作方式稍有不同。

即使是最早的浏览器，也有一些优化使得页面呈现得更快。eg：滚动内容时，浏览器将保留仍然可见的部分并移动它，然后，在空白点上绘制新的像素。

这种找出发生了什么变化，然后只更新发生变化的元素或像素的过程称为增量更新。随着时间的推移，浏览器开始应用更多的增了更新技术，比如矩形增量更新。

当页面上没有太多变化时，比如只有一个闪烁的光标，这确实减少了您需要做的工作。但是，这对于大范围的页面变化，帮助并不大。

![闪烁的光标](/note/assets/imgs/cursor-changed.gif)

### 引入图层和合成器

当页面的大部分内容变化时，使用图层会很有帮助，至少在某些情况下是这样。

浏览器中的图层很像PS中的图层，你在不同的层上绘制页面的不同元素，然后把这些层一层一层得叠在一起。

它们作为浏览器的一部分已经很长时间了，最初它们只是用来确保页面的正确呈现。

例如：如果你有一个半透明的元素，它将在它自己的堆叠上下文中。这意味着它有它自己的图层。

某些情况下，某些图层的内容不会变化，浏览器会保留这些图层，浏览器只重新绘制已经改变的图层。某些情况下，图层没有变化，只需要重新合成即可。例如：动画在屏幕移动，滚动。

![滚动的图层](/note/assets/imgs/scroll-layout.gif)

合成器从下面开始：

1、源位图：背景和可滚动内容本身。

2、目标位图：屏幕上展示的。

首先，合成器将背景拷贝到目标位图，然后，它会计算可滚动的哪个部分应该展示，然后将那部分拷贝到目标位图。

这减少了主线程必须完成的绘制工作，但这仍然意味着主线程需要花费时间来合成。

主线程有点像全栈开发人员，它负责DOM，布局和JS，还负责绘制和合成，这导致主线程非常忙。

![主线程工作](/note/assets/imgs/main-thread.png)

但还有另一部分硬件闲置着，这个硬件就是GPU，专门为图形设计的。

## GPU加速合成

所以浏览器开发者将部分工作转移到GPU。

有两个任务会转移到GPU：

1、绘制图层。很难将绘制转移到GPU，大多数情况下，多平台浏览器都在CPU上绘制。

2、图层合成。合成GPU可以很快完成，而且容易转移到GPU。

有的浏览器甚至更进一步，在CPU上增加合成器线程，它成为了GPU合成工作的管理者。这将所有的合成工作从主线程移走。

它仍然在主线程上留下许多工作，每当需要重新绘制图层时，主线程需要绘制，然后将它转移给GPU。

一些浏览器将绘制转移到另一个线程(Firefox进行中)，但是把绘制转移到GPU会更快。

## GPU加速绘制

所以，浏览器开始将绘制转移到GPU。

![主线程工作](/note/assets/imgs/paint-to-gpu.png)

在GPU上绘制的优点：1、它释放了CPU，把时间可以用来执行JS或布局。2、绘制像素方面，GPU比CPU快得多，所以它加快了绘制速度，也意味着从CPU复制更少的数据到GPU。



## 参考文档

https://hacks.mozilla.org/2017/10/the-whole-web-at-maximum-fps-how-webrender-gets-rid-of-jank/