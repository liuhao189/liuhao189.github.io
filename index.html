<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <link rel="shortcut icon"
            href="/ico.png">
        <meta name="viewport"
            content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible"
            content="ie=edge">
        <title>北边柳的个人网站</title>
        <link rel="stylesheet"
            href="./style/main.css">
        <script>
            var _hmt = _hmt || [];
            (function () {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?256376ad73e3e50091706bb3c032e74c";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
            })();
        </script>
        <script>
            function registerSW() {
                if (navigator.serviceWorker) {
                    navigator.serviceWorker.register('/sw.js?version=1');
                }
            }

            function idleCallback(fn, context, args) {
                if (!fn || typeof fn !== 'function') return;
                if (window.requestIdleCallback) {
                    let cancelToken = window.requestIdleCallback(() => {
                        fn.apply(context, args);
                        cancelToken = null;
                    });
                    return function () {
                        if (!cancelToken) return;
                        window.cancelIdleCallback(cancelToken);
                    }
                } else {
                    let timerId = setTimeout(() => {
                        fn.apply(context, args);
                        timerId = null;
                    }, 3000)
                    return function () {
                        if (!timerId) return;
                        clearTimeout(timerId);
                    }
                }
            }

            function checkCache() {
                idleCallback(() => {
                    let storage = navigator.storage || null;
                    if (storage && storage.estimate) {
                        storage.estimate().then((result) => {
                            let left = result.quota - result.usage;
                            if (left < 1024 * 1024 * 1024 * 3) {
                                caches.delete('beibianliuALWAYS_CACHE');
                            }
                        })
                    }
                });
            }

            window.addEventListener('load', (ev) => {
                registerSW();
                checkCache();
            });
        </script>
    </head>

    <body>
        <div id="app">
            <div id="notesPart">
                <h1 class="note-part-title">笔记列表</h1>
                <div id="noteCategoryList">
                </div>
            </div>
            <script>
                function fetchRequest(url) {
                    return fetch(url).then(
                        res => res.json()
                    );
                }

                function getCategoryList() {
                    return fetchRequest('/note/note-category.json')
                }

                function getNoteListByCategory(categoryFileName) {
                    return fetchRequest(`/note/dist/${categoryFileName}.json`);
                }

                function buildNoteListWithCategoryEl(categoryName, noteList) {
                    if (!categoryName || !noteList) {
                        return;
                    }

                    let divEl = document.createElement('div');
                    divEl.classList.add(`note-category`);
                    let listHtmlStr = `<ul class="note-list">`;
                    noteList.forEach(noteItem => {
                        listHtmlStr += `<li class="note-list-item"><a href="${noteItem.link}">${noteItem.name}</a></li>`
                    })
                    listHtmlStr += '</ul>';
                    divEl.innerHTML = `<h2 class="category-name">${categoryName}</h2>${listHtmlStr}`;
                    return divEl;
                }

                function runPromiseQueue(fns, cb = () => { }) {
                    function step(inx) {
                        if (inx >= fns.length) {
                            try {
                                cb && cb();
                            }
                            catch (ex) {
                                console.error(ex);
                            }
                            return;
                        }

                        try {
                            let currFn = fns[inx];
                            currFn().then(() => {
                                step(inx + 1);
                            }).catch(err => {
                                console.error(err);
                                step(inx + 1);
                            })
                        } catch (ex) {
                            step(inx + 1);
                        }
                    }

                    step(0);
                }

                getCategoryList().then(categoryList => {
                    if (!categoryList || !categoryList.length) {
                        return;
                    }

                    let noteCategoryListEl = document.querySelector('#noteCategoryList');

                    let fns = categoryList.map(categoryItem => {
                        return function () {
                            return getNoteListByCategory(categoryItem.distFileName).then(noteList => {
                                let el = buildNoteListWithCategoryEl(categoryItem.name, noteList);
                                noteCategoryListEl.appendChild(el)
                            })
                        }
                    })

                    runPromiseQueue(fns, () => {
                        console.log(`successfully!`);
                    })
                });
            </script>
        </div>
    </body>

</html>
